# Morty — Fix Agent PR #366

**Model:** claude-sonnet-4.5  
**Role:** general-purpose  
**Spawn Time:** 2026-02-20T22:40  
**Task:** Address all 5 findings from 3x review agents  

## Fixes Applied

### 1. Shell Injection — Shell Quoting
**File:** src/config.ts  
**Fix:** Wrapped `parts.join()` with proper shell escaping using `shellEscape()` utility.  
**Test:** Added `test-shell-special-chars.ts`.  

### 2. Dangling Value Dedup Bug
**File:** src/dedup.ts  
**Fix:** Updated dedup logic to properly reference deduplicated values.  
**Test:** Added `test-dedup-edge-cases.ts`.  

### 3. Defensive Null Filtering
**File:** src/shell.ts  
**Fix:** Added null/undefined guards on `extraArgs` parameter.  
**Test:** Added `test-null-undefined-args.ts`.  

### 4. Legacy Config Stripping
**File:** src/parser.ts  
**Fix:** Removed all references to deprecated `$(agent)` config syntax.  
**Test:** Added `test-legacy-config-migration.ts`.  

### 5. Path Whitespace Quoting
**File:** src/resolver.ts  
**Fix:** Applied shell quoting to all path resolution output.  
**Test:** Added `test-paths-with-spaces.ts`.  

## Test Results

- **Total Tests:** 30 (11 new)
- **Status:** ✅ All passing
- **Coverage:** Edge cases, null/undefined, special characters, legacy configs, whitespace paths

## Verification

- ✅ No regressions in existing tests
- ✅ All 5 findings addressed
- ✅ Ready for merge
