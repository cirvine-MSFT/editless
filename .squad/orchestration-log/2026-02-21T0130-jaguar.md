# Jaguar Orchestration Log
**Date:** 2026-02-21T01:30Z  
**Agent:** Jaguar (Copilot SDK Expert)  
**Issue:** #370 (ACP Spike)  
**Mode:** Background

## Work Summary

Built complete ACP protocol foundation for EditLess.

### Deliverables

1. **src/acp/types.ts** (272 lines)
   - JSON-RPC base types (Request, Response, Notification, Error)
   - Client→Agent methods: initialize, session/new, session/load, session/prompt, session/cancel
   - Agent→Client notifications: agent_message_chunk, agent_thought_chunk, tool_call, tool_call_update, plan, user_message_chunk, available_commands_update, current_mode_update
   - Agent→Client requests: session/request_permission, fs/read_text_file, fs/write_text_file, terminal/* operations
   - Discriminated unions for type-safe update handling

2. **src/acp/client.ts** (342 lines)
   - JSON-RPC engine spawning copilot --acp --stdio
   - NDJSON parsing with line-buffered stream handling
   - Bidirectional request/response tracking via Map<id, {resolve, reject}>
   - EventEmitter pattern (VS Code EventEmitter) for streaming: message_chunk, thought_chunk, tool_call, tool_call_update, plan, stopped, error
   - Handler interface (AcpRequestHandler) for agent→client requests
   - Full lifecycle: initialize() → createSession(cwd) → prompt(sessionId, text) → dispose()
   - Proper cleanup: kills child process, rejects pending promises, disposes emitters

3. **src/acp/handlers.ts** (89 lines)
   - Spike handler implementation of AcpRequestHandler interface
   - Auto-approves all permission requests (spike-only behavior)
   - fs/read_text_file via Node fs/promises
   - Stub errors for fs/write_text_file and terminal/* (out of scope)
   - Request logging to VS Code output channel

### Key Decisions

- **Three-layer architecture**: Types → Client → Handlers (separation of concerns)
- **NDJSON buffering**: Safety against partial line reads from stdout
- **Handler interface abstraction**: Decouples protocol from VS Code APIs, enables testing and future capabilities
- **Type guards + discriminated unions**: Full type safety for 15+ message types
- **Uses existing buildCopilotCommand()**: Integration with src/copilot-cli-builder.ts

### Testing Status

- Protocol type validation verified during implementation
- Client compiles cleanly
- Architecture matches ACP spec patterns from Zed/JetBrains

## Decisions Created

- `.squad/decisions/inbox/jaguar-acp-spike-architecture.md`
- `.squad/decisions/inbox/jaguar-acp-deep-dive.md`

## Next Agent: Morty

Morty will integrate this protocol layer into VS Code surface (src/acp/panel.ts, extension.ts, package.json modifications).
