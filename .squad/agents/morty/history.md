# Project Context

- **Owner:** Casey Irvine
- **Project:** EditLess ‚Äî a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings

üìå **Terminal UUID pre-generation pattern (#323, #326) ‚Äî 2026-02-21:** New terminals now generate session UUIDs BEFORE terminal creation using `crypto.randomUUID()`, then immediately pass `--resume ${uuid}` to the CLI. This eliminates orphan detection races for new terminals. Implementation: `launchTerminal()` sets `info.agentSessionId = uuid` immediately, builds command via `buildCopilotCommand({ agent, resume: uuid })`, and starts file watching on events.jsonl via `_sessionResolver.watchSession(uuid, callback)`. Kept `detectSessionIds()` for backward compatibility with existing terminals. Terminal options include `isTransient: true` (prevents zombie terminals on reload), `iconPath`, and `env` with EDITLESS_TERMINAL_ID/SQUAD_ID/SQUAD_NAME. File watcher pattern: debounced (100ms), tail-reads events.jsonl on change, auto-retries if file doesn't exist yet. `focusTerminal()` now accepts `terminal: vscode.Terminal | string` for stable focus by ID lookup. `show(false)` means preserveFocus=false.

üìå **Simplified session state model (PR #354, 2026-02-19):** Removed granular session state detection (working/waiting-on-input/idle/stale) in favor of a 3-state model: active, inactive, orphaned. The old model used events.jsonl parsing with time-based thresholds (5min idle, 1hr stale) which was flawed and required 4 PRs to fix. New model uses only shell execution tracking (`_shellExecutionActive` from VS Code's onDidStart/EndTerminalShellExecution) as the signal for active/inactive. Icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Description: relative time for active/inactive, "previous session" for orphaned. Kept SessionContextResolver infrastructure for future features, just stopped using getLastEvent() for state. This removes ~130 lines of test code and ~60 lines of prod code while making the state model obvious.


üìå **Team update (2026-02-17):** Release branching strategy ‚Äî Ship from master, no release branches yet. v0.1.x bugfixes and v0.2.0 features ship from master. No release branches until parallel release lines needed. Version bump happens right before tagging. ‚Äî decided by Casey

üìå **Team update (2026-02-16):** Documentation animation strategy ‚Äî EditLess uses optimized GIFs stored in docs/media/ directory. Primary tool: ScreenToGif (Windows). Files must be <1 MB, max 800px width, 3‚Äì8 seconds duration. File naming is descriptive kebab-case (e.g., planning-feature.gif). Re-recording triggers documented: UI structure changes, command/shortcut changes, label changes, layout changes. Team reviews animations on code review checklist. ‚Äî decided by Summer

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-16):** Default release target ‚Äî All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. ‚Äî decided by Casey Irvine

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint ‚Äî Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. ‚Äî reinforced by Casey Irvine

üìå **Team update (2026-02-16):** Use context keys for menu visibility based on dynamic state ‚Äî Gate menu items on VS Code context keys when visibility depends on runtime state that can't be expressed through `viewItem` checks. For the "Upgrade All Squads" button, use `editless.squadUpgradeAvailable` context key set via `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()`. This pattern applies to all view-level actions depending on aggregate state (e.g., "any squad upgradeable"). ‚Äî decided by Morty

üìå **Team update (2026-02-16):** Meeseeks writes regression tests for every bug Casey discovers ‚Äî When Casey discovers a bug during usage, Meeseeks should write regression tests for that specific scenario BEFORE Morty fixes it. Tests-first approach for all user-discovered bugs ensures proper coverage and clear verification criteria when the fix lands. ‚Äî decided by Casey Irvine

- **F2 keybinding with terminalFocus doesn't work (#229):** VS Code's terminal captures raw F2 keycode before the extension keybinding system processes it, causing "q" to be sent to terminal instead of triggering rename. When terminal is focused, key events are consumed by terminal first. Terminal-scoped keybindings are unreliable for extension commands ‚Äî use context menus, command palette, or tree view keybindings instead. Removed `"when": "terminalFocus"` F2 binding. Tree view F2 bindings still work because editlessTree gets focus priority.
üìå **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests ‚Äî Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. ‚Äî decided by Casey Irvine
üìå **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint ‚Äî Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. ‚Äî reinforced by Casey Irvine

üìå **Session (2026-02-22T21:57Z):** Fixed ADO filter hierarchy collapse in work-items-tree.ts ‚Äî When ADO is the only visible backend, the filter was returning a flat list of work items instead of preserving the org ‚Üí project hierarchy. Changed `_getAdoRootItems()` flat return to `_getAdoOrgNodes()` to preserve the hierarchy. Updated 12 tests, added 2 new tests. 787 tests pass. Commit: 2ec5134. ‚Äî Morty

üìå **Registry watcher refresh optimization (PR #427, #399):** Three bottlenecks in the registry-change ‚Üí tree-refresh chain: (1) `scanSquad(config)` was called in SquadWatcher callback but result discarded ‚Äî pure sync I/O waste; tree provider re-scans via `getState()` lazily anyway. (2) `squadWatcher.updateSquads()` recreated all FS watchers synchronously after `treeProvider.refresh()`, blocking the event loop and delaying rendering; fix: defer with `setTimeout(0)`. (3) `watchRegistry` callback now receives already-loaded squads, eliminating a redundant `loadSquads()` disk read. Also lowered `scanDebounceMs` default 500‚Üí300ms. 910 tests pass. Commit: 648e2fb. ‚Äî Morty

üìå **Config handler debounce pattern (PR #424, review feedback):** `onDidChangeConfiguration` handlers for integration settings (ADO org/project, GitHub repos) now use 500ms setTimeout/clearTimeout debounce to prevent concurrent API calls from rapid keystroke changes (typing org name character-by-character). Each handler maintains its own debounce timer variable (`adoDebounceTimer`, `githubDebounceTimer`). Test pattern: use `vi.useFakeTimers()` + `vi.advanceTimersByTime(500)` to verify debounced execution. All config handler tests (including edge cases like empty values) must account for debounce delay. 918 tests pass. Commit: 2a7832a. ‚Äî Morty

<!-- Append new learnings below. Each entry is something lasting about the project. -->

üìå **Team update (2026-02-17):** Sticky terminal names ‚Äî user requirement and implementation pattern consolidated ‚Äî When a terminal is launched via "Launch with Agent" from a work item or PR, the terminal title must be treated as a sticky label and not overridden by session context or auto-rename logic. Implementation: code paths creating terminals with custom names must call `labelManager.setLabel(labelKey, name)` after `terminalManager.launchTerminal()`. The pattern applies to any future command that launches a terminal with a user-meaningful name (e.g., `launchFromWorkItem`, `launchFromPR`). ‚Äî decided by Casey Irvine & Morty
üìå **Resume External Session command (PR #426, issue #415):** `editless.resumeExternalSession` reads all sessions from `~/.copilot/session-state/` via `SessionContextResolver.getAllSessions()` (flat array from CWD index), filters out tracked+orphaned sessions, sorts CWD-matched to top, and presents a searchable QuickPick. Validates resumability via `isSessionResumable()` before launching. Uses `buildCopilotCommand({ resume: uuid })` ‚Äî the terminal is standalone (not tracked by TerminalManager) since it's an external session. `CwdIndexEntry` is now exported. Context menu on `session@1` group for squad/agent/default-agent viewItems. ‚Äî Morty

üìå **CWD resolution expanded to 3 agent types (PR #412, #403):** `resolveTerminalCwd()` in `src/terminal-manager.ts` now handles personal agents (~/.copilot/agents/ ‚Üí first workspace folder), repo agents (path inside workspace under .github/agents/ etc. ‚Üí that workspace root), and workspace-dir agents (any path inside a workspace folder ‚Üí that folder root). Priority order: workspace folder match first, then personal agent .copilot/agents fallback. Uses forward-slash normalization via `normSep()` for cross-platform comparison. 842 tests pass. Commit: 6814ce5. ‚Äî Morty

üìå **Team update (2026-02-17):** Sticky terminal names‚Äî user requirement and implementation pattern consolidated ‚Äî When a terminal is launched via "Launch with Agent" from a work item or PR, the terminal title must be treated as a sticky label and not overridden by session context or auto-rename logic. Implementation: code paths creating terminals with custom names must call `labelManager.setLabel(labelKey, name)` after `terminalManager.launchTerminal()`. The pattern applies to any future command that launches a terminal with a user-meaningful name (e.g., `launchFromWorkItem`, `launchFromPR`). ‚Äî decided by Casey Irvine & Morty

üìå **Team update (2026-02-19):** User directive ‚Äî Unified discovery/add flow for squads and agents ‚Äî Squads and standalone agents should share roughly the same flow through the code for discovery and add. Special-casing is fine for details (which dirs to scan, how to register), but the user-facing experience should be unified ‚Äî squads get a squad icon, agents get their own icon, but the paths (discovery, add, refresh) should be the same. Refactor discovery and add commands to eliminate separate code paths. ‚Äî directed by Casey Irvine

üìå **Team update (2026-02-19):** User directive ‚Äî Delete squad-upgrader.ts entirely ‚Äî Delete squad-upgrader.ts entirely (not kept for utilities). Move the 4 kept functions elsewhere and delete the file. The design review decision to keep the file name has been overridden by user request. This supersedes prior Rick design review decision (#303) for full file deletion. ‚Äî directed by Casey Irvine

üìå **Team update (2026-02-19):** Feature removal checklist expanded ‚Äî PR #320 (remove terminal-layout) established that feature removals must include documentation cleanup. Expanded checklist: (1) source file, (2) test file, (3) extension wiring, (4) test mocks, (5) settings in package.json, (6) all doc references (docs/architecture.md, SETTINGS.md, local-development.md, etc.), (7) CHANGELOG. This pattern prevents recurring gaps seen in #303 (squad upgrade removal). ‚Äî decided by Rick

üìå **CLI flag builder replaces $(agent) interpolation (PR #366, issue #325):** Created `src/copilot-cli-builder.ts` with `buildCopilotCommand(options: CopilotCommandOptions)` and `buildDefaultLaunchCommand()`. The `$(agent)` placeholder in `editless.cli.launchCommand` was never replaced at runtime ‚Äî new builder constructs commands from typed inputs. New setting `editless.cli.defaultAgent` (default: `squad`) controls the `--agent` flag. `getLaunchCommand()` in `cli-settings.ts` kept as deprecated wrapper. Supports `--agent`, `--resume`, `--continue`, `--model`, `--add-dir`, `--allow-all-tools`. 17 tests cover all flag combinations. ‚Äî decided by Morty

üìå **extraArgs with intelligent dedup added to CLI builder (PR #366 review feedback):** Added `extraArgs?: string[]` to `CopilotCommandOptions` for freeform CLI flags like `--yolo`. Dedup strategy: typed flag values always win over duplicates in extraArgs; unknown flags pass through unconditionally; if a typed flag is unset but appears in extraArgs it passes through. Uses a `Set<string>` of active typed flags for O(1) lookup. `console.warn()` on dedup for debugging, no UI notification. extraArgs appended after all typed flags. 7 new tests (24 total). ‚Äî decided by Morty, requested by Casey

üìå **Team update (2026-02-19):** Terminal Integration audit merged ‚Äî Synthesized research from three specialists (Jaguar: VS Code APIs, Morty: code-level bugs, Squanchy: squad mental model) into a unified architecture plan with 27-item priority matrix across 4 phases. **Phase 1 (v0.1.1):** Fix P0 race conditions (sendText before show, session ID detection), add TerminalOptions (isTransient, iconPath, color, env), improve orphan matching. **Phase 2 (v0.2.0):** CWD index for perf, exit code tracking, link provider, CLI builder, terminal state API. **Phase 3 (v0.2.x):** Session summaries in terminal names, decision inbox badges, orchestration log parsing. **Phase 4 (v0.3.0+):** Dashboard webview, Agent Mode tracking, multi-agent progress. Decisions archived to decisions.md. ‚Äî decided by Rick

üìå **Team update (2026-02-18):** Dev Tooling ‚Äî Isolated Environment Strategy ‚Äî EditLess extension development now standardizes on isolated VS Code environments using `.vscode/launch.json` with three debug configs (standard, isolated, tests), `.vscode/tasks.json` for build automation, and `scripts/dev-isolated.ps1` for manual isolated launches. Isolation flags: `--user-data-dir=<path>` + `--disable-extensions` + `--extensionDevelopmentPath=<path>`. Key pattern: all debug configs reference `${defaultBuildTask}` so esbuild runs before launch. Team members use "Run Extension (Isolated)" for bug reproduction and first-run testing, standard "Run Extension" for daily dev. ‚Äî decided by Morty

üìå **Team update (2026-02-22):** Universe auto-detection from .squad/casting/registry.json ‚Äî Registry-based fallback for agent universe discovery when team.md unavailable. Priority chain: (1) team.md **Universe:** field, (2) registry.json agent‚Üíuniverse mapping, (3) 'unknown'. Implementation at caller level in `discovery.ts` maintains clean separation of concerns. Deployed in v0.2-prep work (#337, #393). ‚Äî implemented by Morty

üìå **Team update (2026-02-22):** CWD-indexed session cache optimization ‚Äî SessionContextResolver now uses O(1) CWD index instead of O(n) directory scans. `_ensureIndex()` uses directory count as invalidation heuristic. Two-level cache: 30s TTL results + dir-count-validated index. Reduces per-poll resolution from ~100ms to <5ms for 200+ sessions. No API changes. #331. ‚Äî implemented by Morty

üìå **Team update (2026-02-21):** Unified discovery UX designed for agents & squads ‚Äî Summer delivered UX design for unified discovery architecture (v0.2): single "Discovered" section in tree with both agents and squads, context menu actions (Add to Registry, Hide), persistent "Hidden" section, and integration path for "Add from Existing" flow (#318). Visual distinction via icons (hubot=agent, organization=squad). Implementation sketch provided: editless-tree.ts (new TreeItemType), visibility manager, unified discovery functions, extension commands. MVP targets agents initially, squads Phase 2. Design doc filed to decisions.md. ‚Äî designed by Summer

üìå **Team update (2026-02-17):** PR filter pattern mirrors work items filter ‚Äî The `PRsFilter` interface in `prs-tree.ts` matches work items exactly: `repos`, `labels`, `statuses` arrays with `setFilter()` / `clearFilter()` / `isFiltered()` / `getFilterDescription()` methods. Label matching uses OR-within-group / AND-across-groups logic via `matchesLabelFilter()`. Context key `editless.prsFiltered` gates menu visibility. When adding filter support to new tree views, follow this same pattern. The label matching logic is duplicated between `work-items-tree.ts` and `prs-tree.ts` ‚Äî a future refactor could extract it to a shared utility. ‚Äî documented by Morty

üìå **Team update (2026-02-15):** Command category pattern standardized ‚Äî all commands use `"category": "EditLess"` instead of title prefix to clean context menus while preserving command palette discoverability. This is now a team decision. ‚Äî decided by Casey Irvine

- **Command category pattern:** Use `"category": "EditLess"` on commands instead of prefixing titles with "EditLess: ". VS Code shows the category in the command palette but omits it in context menus ‚Äî clean context menus without losing discoverability.
- **F2 rename from terminal:** Clicking a tree terminal item intentionally focuses the terminal (`terminal.show()`). A second F2 keybinding with `"when": "terminalFocus"` covers the rename flow after focus moves. The `renameSession` handler falls back to `vscode.window.activeTerminal` when no arg is provided so the keybinding resolves the right terminal without a QuickPick.
- **Startup checks must be non-blocking:** `checkAgencyOnStartup` was using `execSync` which blocks the entire extension activation. Replaced with async `exec` callback. Any startup probe that shells out must use async execution to avoid freezing the activation path.
- **Cache user-facing prompts in globalState:** Toasts that fire on reload (like the agency update prompt) need dedup logic. Use `context.globalState` with a version+timestamp cache keyed by feature name. 24-hour cooldown prevents nagging while still re-checking after a reasonable interval or when the installed version changes.
- **User-facing text vs internal code:** When renaming user-facing strings (e.g. "squads" ‚Üí "agents"), only touch string literals shown to users ‚Äî status bar text, QuickPick placeholders, toast messages, and `package.json` view names. Leave internal variable names, function names, file names, and test fixture data unchanged. Squad-specific features (squad-upgrader) that reference the Squad CLI product keep "squad" in their messages.
- **Provider update infrastructure is generalized:** Update checking in `cli-provider.ts` is driven by optional `updateCommand`, `upToDatePattern`, and `updateRunCommand` fields on `CliProvider`. To add update support for a new CLI, just populate those fields in `KNOWN_PROFILES` ‚Äî no new functions needed. Cache keys are per-provider (`editless.${name}UpdatePrompt`). The old `checkAgencyOnStartup` still exists as a deprecated alias for `checkProviderUpdatesOnStartup`.
- **Terminal session persistence pattern:** `TerminalManager` persists terminal-to-squad mappings in `workspaceState` (key: `editless.terminalSessions`) and reconciles with live `vscode.window.terminals` on reload by matching `terminal.name`. The `TerminalInfo` interface stays unchanged ‚Äî a separate `PersistedTerminalInfo` serializes `Date` ‚Üí ISO string and adds `terminalName` for reconciliation. `_persist()` is called after every mutation (launch, close). `reconcile()` runs once after tree provider setup during activation.
- **Notification settings pattern:** Notifications use a master toggle (`notifications.enabled`) plus per-category booleans (`notifications.inbox`, `notifications.updates`). The shared `isNotificationEnabled(category)` helper in `notifications.ts` checks both ‚Äî master off kills all, otherwise defers to the category setting. New notification categories follow this same pattern: add a setting, pass the category key to the helper.
- **Agent discovery (#2 + #18):** Added `src/agent-discovery.ts` ‚Äî scans workspace `.github/agents/*.agent.md` and root-level `*.agent.md` files on activation, surfaces them in the tree view as read-only "Discovered Agents" section.
- **Add Agent / Add Squad buttons (#13):** Added `editless.addAgent` (creates `.github/agents/{name}.agent.md` template, re-runs discovery) and `editless.addSquad` (folder picker ‚Üí `git init` + `npx squad init` in a terminal) as header actions on the Agents pane.
- **Three-pane sidebar (#4):** Split sidebar into Agents, Work Items, and PRs collapsible views. Work Items and PRs are placeholder tree providers for future GitHub/ADO integration.
- **Launch from Work Item (#7):** Right-click context menu on work items shows a QuickPick of all registered agents/squads. Selecting one launches a terminal named after the issue, copies the issue URL to clipboard. Added optional `customName` parameter to `TerminalManager.launchTerminal`.
- **Plan Detection (#6):** Work item tree items now show plan status ‚Äî checks issue labels for "has plan", "has-plan", "plan", or "planned". Shows üìã for planned items and ‚ùì for items needing a plan, with description updated accordingly.
- **Work Item Type Filter (#17):** Added `editless.github.issueFilter` setting with `includeLabels` and `excludeLabels` arrays. Filtering is applied after fetching ‚Äî exclude hides matching issues, include restricts to matching issues, empty means show all.
- **Milestone Grouping (#10):** Issues with milestones are grouped under collapsible milestone headers in the Work Items tree. Issues without a milestone go under a collapsed "No Milestone" group. Falls back to flat list when no milestones exist.
- **Version Toasts (#51):** Update toasts now show both installed and available versions (e.g. "1.2.3 ‚Üí 1.3.0") when the available version can be parsed from the update command output. Falls back to current-only format when parsing fails.
- **Markdown Preview (#41):** Discovered agent `.md` files now open in VS Code's built-in markdown preview instead of the text editor. Added `editless.openFilePreview` command that delegates to `markdown.showPreview`.
- **PR Links (#33):** Added `editless.goToPR` context menu command on work items. Uses `gh pr list --search` to find PRs referencing the issue number. Single PR opens directly; multiple PRs show a QuickPick. Added `fetchLinkedPRs` to `github-client.ts`.
- **Settings schema polish (#88):** Added `markdownDescription`, `scope`, and `order` to all 11 settings. Added `enumDescriptions` and `enumItemLabels` to `cli.provider`. Order groups: Core (1‚Äì3), Notifications (10‚Äì12), CLI/Agent (20‚Äì22), GitHub (30‚Äì31). Scope: `resource` for workspace-specific paths/configs, `window` for user preferences. `discovery.scanPaths` was intentionally skipped (not in the plan's 11 settings).
- **Inline close button (#92):** Reused the existing `editless.closeTerminal` command ‚Äî added `"icon": "$(close)"` and an `inline@99` menu entry. No new command or handler needed. When an existing command already does what you need, just wire it into the UI layer (icon + menu placement).
- **Async CLI probing + custom provider (#107, #109):** Replaced `execSync` with async `exec` in `probeCliVersion()` to eliminate 15s activation freeze. `probeAllProviders()` is now async, called fire-and-forget from `activate()` with `resolveActiveProvider()` chained via `.then()`. Added `custom` profile to `KNOWN_PROFILES` with empty command/versionCommand for presence-only detection. `resolveActiveProvider()` now honors explicit `custom` setting without requiring a probe. Updated all tests for async flow. PR #121.
- **P1 code quality fixes (#114, #116, #117, #119):** Four mechanical fixes batched into one PR. (1) Added `getLastActivityAt()` public getter to `TerminalManager` to replace bracket-notation private field access in `editless-tree.ts`. (2) Stored the leaked `labelManager.onDidChange()` subscription, added `dispose()` to `EditlessTreeProvider` implementing `vscode.Disposable`, pushed provider to `context.subscriptions`. (3) Removed 4 dead prototype types from `types.ts` (`TerminalSession`, `DashboardState`, `WebSocketMessage`, `LaunchRequest`) ‚Äî zero imports anywhere. (4) Removed unused `promptRenameSession` export from `session-labels.ts`. All 200 tests pass, tsc clean. PR #124.
- **Remove custom commands feature (#131):** Removed `editless.customCommands` setting, `editless.runCustomCommand` command + handler, context menu entry, `CustomCommandEntry` interface, and `custom-commands.test.ts`. Updated `custom` CLI provider enum description to not reference the removed feature. Updated `docs/SETTINGS.md`. The `editless.agentCreationCommand` setting (separate feature) was intentionally preserved ‚Äî its local variable `customCommand` is unrelated naming. 340 tests pass, tsc clean. PR #134.
- **Deep-link configure buttons (#102):** Work Items and PRs tree views now show two configure links when no repos are set: "Configure in GitHub" (opens settings filtered to `editless.github`) and "Configure in ADO" (opens settings filtered to `editless.ado`). Added `editless.ado.organization` and `editless.ado.project` settings as foundation for future ADO integration. Registered `editless.configureAdo` command. Widened GitHub filter from `editless.github.repos` to `editless.github` to show all GitHub settings. 349 tests pass, tsc clean. PR #138.
- **Session status: working vs waiting-on-input (#133):** Split the generic `active` SessionState into `working` (shell execution in progress) and `waiting-on-input` (execution finished, user needs to respond). `getStateIcon` maps working‚Üí`loading~spin`, waiting-on-input‚Üí`bell-dot`. Detection: `shellExecutionActive=true` ‚Üí working; recent activity but no execution ‚Üí waiting-on-input; beyond idle threshold ‚Üí idle/stale as before. `needs-attention` does NOT override `working` (per team decision). `editless-tree.ts` needed no changes ‚Äî it delegates to helper functions. 348 tests pass, tsc clean. PR #137.
- **PR merge conflict indicator (#129):** Added `mergeable` field to `GitHubPR` interface and `fetchMyPRs`/`fetchLinkedPRs` queries. PRs with `mergeable === 'CONFLICTING'` show a `warning` ThemeIcon (with `list.warningForeground` color), `‚ö†Ô∏è has conflicts` in the description, and a conflict warning in the tooltip. UNKNOWN/empty states are handled gracefully (no indicator). 6 new tests, 354 total pass, tsc clean. PR #136.
- **Background terminal on squad add (#127):** Added `hideFromUser: true` to `createTerminal` options in `editless.addSquad` command and removed `terminal.show()`. Only the squad init/upgrade terminal is hidden ‚Äî `launchTerminal` in `terminal-manager.ts` and `addAgent` custom-command terminal remain user-visible since they're explicitly user-initiated. 348 tests pass, tsc clean. PR #135.
- **Terminal layout restore (#40):** Added `TerminalLayoutManager` in `src/terminal-layout.ts` ‚Äî listens to `onDidChangeVisibleTextEditors` and fires `workbench.action.toggleMaximizedPanel` when all editors close after being opened from a no-editor state. Tracks `hadVisibleEditors` and `panelWasMaximized` to avoid false triggers. Added `editless.restoreTerminalLayout` boolean setting (default: true, order: 4, scope: window). Setting is read live on each event so it can be toggled mid-session. 7 new tests, 354 total pass, tsc clean. PR #142.
- **Persistent upgrade indicator (#91):** Squad items now show `upgrade available` in their description when the local Squad CLI version is older than the latest on GitHub. Added `getLatestSquadVersion()` (HTTPS fetch from `raw.githubusercontent.com`, cached 1hr), `isNewerVersion()` semver comparison, and `checkSquadUpgradesOnStartup()` in `squad-upgrader.ts`. Tree provider stores upgrade state in `_upgradeAvailable` map; sets `contextValue` to `squad-upgradeable` for upgradeable squads. Inline upgrade button now only shows for squads with available upgrades (`viewItem == squad-upgradeable`); other squad menus use regex match (`viewItem =~ /^squad/`). Indicator clears after upgrade completes via `onUpgradeComplete` callback. 7 new tests (isNewerVersion + tree indicator), 358 total pass, tsc clean. PR #145.
- **Tree UX: click to expand, + button for new session (#144):** Removed `command` property from squad tree items so clicking expands/collapses (standard VS Code tree behavior) instead of launching a terminal. Added `$(add)` inline button on squad and agent nodes via `view/item/context` menu contribution with `viewItem =~ /^squad|^agent$/`. Updated `editless.launchSession` handler to accept both `string` (squadId) and `EditlessTreeItem` arguments. Agent items now carry `squadId` so the inline button resolves the correct squad. 368 tests pass, tsc clean. PR #147.
- **Work items plan icon fix (#139):** `buildIssueItem()` in `src/work-items-tree.ts` had a binary planned/not-planned check that didn't recognize `status:planned` or `status:needs-plan` GitHub labels. Replaced with ternary logic: planned (üìã, matches `status:planned` + legacy labels), needs-plan (‚ùì, matches `status:needs-plan`), and neutral (‚Äî, no plan label). Tooltip and description update accordingly. Created `src/__tests__/work-items-tree.test.ts` with 15 tests covering all label variants, case-insensitivity, and precedence when both labels present. 383 tests pass, tsc clean.
- **Squad folder rename backward compat (#93):** Created `src/team-dir.ts` with `resolveTeamDir()`, `resolveTeamMd()`, and `TEAM_DIR_NAMES` constant. The utility checks `.squad/` first (new Squad CLI convention), then `.ai-team/` (legacy fallback). Updated `discovery.ts`, `scanner.ts`, `squad-upgrader.ts`, and `watcher.ts` to use the utility instead of hardcoded `.ai-team` paths. Error messages now say `.squad/ (or .ai-team/)`. Created `src/__tests__/team-dir.test.ts` (12 tests). Added `.squad/` tests to discovery and scanner test suites. 409 tests pass, tsc clean.
- **Session persistence for crash recovery (#94):** Added `agentSessionId` and `launchCommand` optional fields to both `TerminalInfo` and `PersistedTerminalInfo`. `launchCommand` is captured from `AgentTeamConfig` during `launchTerminal()` and persisted to `workspaceState`. `relaunchSession()` now sends the persisted `launchCommand` (or `launchCommand --resume <agentSessionId>` when a session ID exists) instead of creating a silent terminal. Added `setAgentSessionId()` public method for external session ID association. All new fields flow through reconcile, reconnect, and persist paths. The `deactivate()` handler already called `persist()` ‚Äî no change needed there. 14 new tests, 409 total pass, tsc clean.

üìå **Team update (2026-02-16):** v0.1 Release Triage & Scope Lock ‚Äî #148 (session labels off by one) triaged as P0 and assigned to you. 7 P0 items locked for v0.1, 8 P1 items prioritized, 5 items cut to post-v0.1. Scope lock: no new v0.1 items after 15:00 UTC. ‚Äî decided by Rick

üìå **Team update (2026-02-16):** Session State Design Issue ‚Äî `waiting-on-input` misclassification documented as a P2 design issue in decisions.md. Investigation revealed that the heuristic conflates "recent activity" with "waiting for user input" and has no positive signal to distinguish legitimate input-waiting scenarios. Fix requires inverting the default to `idle` and introducing a separate `_waitingOnInput` signal or terminal output parsing. Filed as issue #226. ‚Äî investigated by Morty
- **Session state `waiting-on-input` misclassification (investigation):** `getSessionState()` in `terminal-manager.ts:336-365` defaults to `waiting-on-input` for any terminal with `_lastActivityAt` within the 5-minute idle threshold and no active shell execution. This means every terminal shows `waiting-on-input` for up to 5 minutes after any command finishes ‚Äî even when idle. Root cause is a design issue: `onDidEndTerminalShellExecution` (line 86-89) sets both `_shellExecutionActive=false` and `_lastActivityAt=Date.now()`, but there is no positive signal distinguishing "agent asking a question" from "command finished normally." The reconcile path (line 449) restoring `_lastActivityAt` from `persisted.lastSeenAt` amplifies this on reload. Fix requires inverting the default to `idle` and introducing a separate positive signal for `waiting-on-input`.
- **Filter category grouping (#213):** The work items filter now groups active filters by their label prefix (everything before the colon). Within each prefix group (e.g., `release:`), filters use OR logic. Across different prefix groups (e.g., `type:` + `release:`), filters use AND logic. This lets you say "show me docs OR bugs from v0.1 OR backlog" by selecting `type:docs`, `type:bug`, `release:v0.1`, `release:backlog`. The pattern is implemented in a private `matchesLabelFilter()` helper that groups by prefix, checks OR within each group, and AND across groups.
- **Upgrade All button context key (#228):** The "Upgrade All Squads" button now uses a context key `editless.squadUpgradeAvailable` to gate visibility instead of always showing when the Agents view is active. VS Code's TreeView API doesn't support dynamic menu visibility based on tree contents, so we use `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()` to track whether any squad has an upgrade available. The `onUpgradeComplete` callback re-runs the check to update the context key. The per-squad inline button already used `viewItem == squad-upgradeable`, now both buttons are gated consistently.

- **Add Squad silent failure (#232):** The `addSquad` handler created a hidden terminal (`hideFromUser: true`, added in #127) to run `npx squad init` but never registered the resulting squad. Two issues: (1) `sendText` didn't include `exit`, so the hidden terminal stayed open forever; (2) nothing listened for terminal completion to trigger registration. Fix: append `; exit` to the command, register an `onDidCloseTerminal` listener that discovers and registers the squad via `discoverAgentTeams()` on the parent directory when the terminal closes. The listener filters by terminal identity and auto-disposes. Key pattern: when using hidden terminals for background work, always ensure the shell exits and wire up a completion listener ‚Äî `sendText` alone is fire-and-forget.
- **ADO auth auto-prompt and error logging (#252):** `getAdoToken()` in `ado-auth.ts` used `createIfNone: false` and silently swallowed errors in empty catch blocks. `initAdoIntegration()` in `extension.ts` showed a warning toast when no token was found without first attempting `promptAdoSignIn()`. Fix: (1) `initAdoIntegration` now calls `promptAdoSignIn()` (createIfNone: true) before falling back to the warning toast, so first-time users with org+project configured get the Microsoft SSO dialog automatically. (2) QuickPick descriptions for ADO changed from "Configure Azure DevOps project and PAT" to "Configure Azure DevOps project" since Microsoft SSO is the primary auth strategy. (3) Added `setAdoAuthOutput()` to `ado-auth.ts` ‚Äî a module-level setter wired during `activate()` ‚Äî so auth provider and az CLI errors are logged to the EditLess output channel instead of silently dropped. `promptAdoSignIn` also logs its errors now. 6 regression tests, 608 total pass, tsc clean. PR #256.
- **Worktree dev launcher (PR #313 review feedback):** Created `scripts/dev-worktree.ps1` ‚Äî one-command workflow that creates a git worktree for a GitHub issue, installs deps, builds, and launches an isolated VS Code instance. Supports `-Profile` (default "Dev") for lightweight isolation via `--profile`, or full `--user-data-dir` isolation when profile is empty. `-NoBuild` skips install/build for re-entry, `-Clean` nukes `.editless-dev/`. Auto-generates branch slug from issue title via `gh issue view`. Detects main clone root from either worktree or main clone. Removed `.vscode/mcp-dev.json.example` (EditLess doesn't use webviews ‚Äî MCP example was speculative). Trimmed MCP section in docs to a short reference note. Updated `dev-isolated.ps1` to reference the new script as the primary workflow.

- **Context menu improvements (#265):** Removed misleading `editless.goToPR` from work item context menus (only appeared when no PR existed). Added `editless.goToWorkItem` to work item context menu ‚Äî opens the issue/work item URL in browser for both GitHub and ADO work items. Added `editless.launchFromPR` to PR context menu ‚Äî mirrors the work item "Launch with Agent" UX: shows QuickPick of all registered agents, launches terminal with `PR #X Title` naming, and copies PR URL to clipboard. Added `editless.goToPRInBrowser` to PR context menu ‚Äî opens the PR URL directly in browser. All four commands support both GitHub and ADO resources. Commands are suppressed in command palette (`when: false`) since they require tree item context. 12 new tests (3 per command), 638 total pass, tsc clean. PR #266.

üìå **Team decision (2026-02-17):** Context Menu Commands: Suppress in Command Palette ‚Äî All context menu commands that require tree item context (editless.goToWorkItem, editless.launchFromPR, etc.) should be suppressed in command palette via `"when": "false"` to reduce palette clutter and avoid confusing users with commands that require tree item context to function. ‚Äî decided by Morty

- **Sticky terminal names on launch (#267):** When `launchFromWorkItem` creates a terminal with a custom name, it must also call `labelManager.setLabel(labelKey, name)` to make the name "sticky" ‚Äî otherwise the tree view and other code paths don't treat it as a user-set label. The rename flow (`renameSession`) already does three steps: (1) rename VS Code tab, (2) persist via labelManager, (3) update internal displayName. Launch flows that set custom names need step 2 as well. Same pattern applies to `launchFromPR` (PR #266) when it merges. 646 tests pass, tsc clean. PR #268.

- **Plan detection removal (#306):** Removed automatic plan.md file detection and plan status indicators from work items tree. This feature added filesystem scanning overhead (buildPlanFileIndex() walking workspace folders + team dirs) and tree rendering complexity (plan status icons, label matching, tooltip text) for a workflow users can handle manually. Removed: PlanFileIndex type, buildPlanFileIndex() function, _planIndex field, plan-related label matching (has-plan, needs-plan, status:planned), plan emoji indicators (üìã/‚ùì/‚Äî), plan status in descriptions and tooltips, plan-based icon changes (pass/question icons), and 95 test cases. Session context plan.md reading (different feature ‚Äî reads copilot session state for work references) was preserved as documented. Work items tree simplified from ~500 lines to ~450 lines. All 596 tests pass, tsc clean. PR #353.

- **Custom agent creation command removed (#311):** The `editless.agentCreationCommand` setting and its handler in the `addAgent` flow have been fully removed. This feature went through a full build-ship-break-remove cycle (designed, built, found broken, removed, re-imagined, moved to backlog). Removed the setting from package.json, the custom command handler block (~13 lines) from extension.ts, and all references from docs (SETTINGS.md entire section + example, architecture.md table row). The built-in agent creation flow (create from template or import from file) now always runs. This completes the feature removal checklist pattern established in PR #320. 620 tests pass, tsc clean. PR #352.

- **PR filter system (#269):** Added `PRsFilter` interface with `repos`, `labels`, and `statuses` arrays to `prs-tree.ts`, mirroring the `WorkItemsFilter` pattern. Extended `GitHubPR` with `labels` (parsed from `gh` CLI `--json labels`) and `autoMergeRequest` (nullable object). `derivePRState()` now detects `auto-merge` status when `autoMergeRequest` is non-null. Extracted `parsePR()` helper in `github-client.ts` to DRY the `fetchMyPRs`/`fetchLinkedPRs` parsing. Changed PRs tree from `registerTreeDataProvider` to `createTreeView` to support the `description` property for filter status display. Filter methods (`applyRuntimeFilter`, `applyAdoRuntimeFilter`, `matchesLabelFilter`) are public for testability. PR status values: draft, open, approved, changes-requested, auto-merge. 20 new tests (7 prs-tree filter, 8 prs-tree derivePRState/empty, 5 extension-commands), 676 total pass, tsc clean. PR #270.

üìå **Team update (2026-02-18):** v0.1.1 quality release scoped ‚Äî 7 features to remove, 3-5 bugs to fix, extension.ts refactor planned. See decisions.md for full scope ‚Äî decided by Rick + Casey

- **Terminal Integration Deep Audit (2026-02-20):** Comprehensive analysis of terminal-manager.ts, session-context.ts, and related modules identified 14 critical bugs, 8 unused VS Code APIs, and 5 architectural limitations. Key findings: (1) sendText race condition (P0) ‚Äî commands execute before shell initializes, fix by calling sendText before show(); (2) Session ID detection race (P0) ‚Äî multiple terminals in same CWD claim same session, fix by matching closest creation timestamp; (3) Substring orphan matching too greedy (P1) ‚Äî false positives from emoji-stripped names, fix with index-based matching; (4) Missing TerminalOptions.isTransient/iconPath/color/env (P1) ‚Äî no visual distinction, zombie terminals on reload, fix by adding all 4 options; (5) Performance issue (P1) ‚Äî scans all 100+ sessions every 30s, fix with CWD-indexed cache (100ms ‚Üí 5ms). Unused APIs with high impact: registerTerminalProfileProvider (custom profiles), terminal.creationOptions (accurate reconcile), terminal.state.isInteractedWith (better state detection), onDidChangeTerminalState (detect typing). Design issue: waiting-on-input state uses negative inference (any recent activity = waiting), needs positive signal or default-to-idle inversion. Terminal naming: shells strip emoji inconsistently (PowerShell ‚Üí "My Squad #1", bash ‚Üí "üöÄ My Squad #1"), recommend using iconPath/color instead of emoji in names. Effort estimates: v0.1.1 fixes (P0+P1) = 5‚Äì6 hours, v0.2.0 (API adoption) = 10‚Äì12 hours. Full audit written to `.ai-team/decisions/inbox/morty-terminal-audit.md`.

- **Development tooling setup:** Created comprehensive local dev environment for EditLess extension. Added `.vscode/launch.json` with three debug configs: "Run Extension" (F5 standard), "Run Extension (Isolated)" (clean environment with user-data-dir and disable-extensions), and "Extension Tests" (integration test runner). Added `.vscode/tasks.json` with build and watch tasks. Created `scripts/dev-isolated.ps1` PowerShell script for isolated VS Code launches with `-Clean` switch to reset environment. Created `.vscode/mcp-dev.json.example` template with chrome-devtools MCP server config for webview debugging. Updated `.gitignore` to exclude `.editless-dev/` and `.vscode/mcp.json` (personal dev configs). Key pattern: isolated dev environments use `--user-data-dir` + `--disable-extensions` + `--extensionDevelopmentPath` to test first-run experience and avoid conflicts with personal VS Code setup.


üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-16):** Default release target ‚Äî All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. ‚Äî decided by Casey Irvine

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint ‚Äî Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. ‚Äî reinforced by Casey Irvine
üìå **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests ‚Äî Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. ‚Äî decided by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

üìå **Discover/Register UX icon cleanup (PR #425, #418):** Icon-to-meaning mapping is now 1:1 across the tree. `$(play)` = start session (registered only), `$(add)` = register (discovered only), `$(compass)` = discovered item icon, `$(eye-closed)` = hide discovered item. Key locations: `launchSession` command def in package.json (icon+title), `hideAgent` command def (added missing icon), `buildDiscoveredAgentItem()`/`buildDiscoveredItemAgent()`/`buildDiscoveredSquadItem()` in `src/editless-tree.ts` (ThemeIcon changes). Note: the roster category header at line ~434 also uses `organization` icon but is NOT a discovered item ‚Äî leave it alone. 826 tests pass. ‚Äî Morty

üìå **Official Copilot SDK event types added (PR #414, #402):** Created `src/copilot-sdk-types.ts` with `CopilotEventType` string literal union (all 32 official event types from `github/copilot-sdk` v0.1.8 `session-events.schema.json`) and `CopilotEvents` const object for the subset we reference in state detection. `isAttentionEvent()` now only triggers on `tool.execution_start` with `toolName === 'ask_user'` ‚Äî removed dead code `assistant.ask_user` and `user.ask` (never existed in schema). `isWorkingEvent()` cleaned up to only reference official types (removed `assistant.code_edit` and `tool.result`). `SessionEvent` interface kept as simplified `{ type: string }` for forward-compat. 893 tests pass. Commit: 5f01dff. ‚Äî Morty

- **Remove squad upgrade feature (#303):** Deleted `squad-upgrader.ts` and extracted its 4 utility functions (`checkNpxAvailable`, `promptInstallNode`, `isSquadInitialized`, `getLocalSquadVersion`) into `squad-utils.ts`. Removed `editless.upgradeSquad` and `editless.upgradeAllSquads` commands, their menu entries, the `editless.squadUpgradeAvailable` context key, the `_upgradeAvailable` map and `setUpgradeAvailable()` method from the tree provider, and the startup upgrade check. The `addSquad` command now silently registers already-initialized squads via discovery instead of running `squad upgrade` in a hidden terminal. Test file renamed from `squad-upgrader.test.ts` to `squad-utils.test.ts` ‚Äî only tests the 4 extracted functions. Key pattern: when a feature is removed, update all mock declarations in test files that referenced the deleted module.

- **Remove terminal layout restore feature (#309):** Deleted `terminal-layout.ts` (TerminalLayoutManager) and its test file. The feature auto-maximized the terminal panel when all editor tabs closed, but interfered with normal VS Code window behavior. Removal pattern: delete source + test, remove import and instantiation from `extension.ts`, remove `vi.mock` declarations in `auto-refresh.test.ts` and `extension-commands.test.ts`, remove `editless.restoreTerminalLayout` setting from `package.json`. Same feature-removal checklist as #303: source, test, wiring, mocks, settings.

üìå **Team update (2026-02-15):** Command category pattern standardized ‚Äî all commands use `"category": "EditLess"` instead of title prefix to clean context menus while preserving command palette discoverability. This is now a team decision. ‚Äî decided by Casey Irvine

- **Command category pattern:** Use `"category": "EditLess"` on commands instead of prefixing titles with "EditLess: ". VS Code shows the category in the command palette but omits it in context menus ‚Äî clean context menus without losing discoverability.
- **F2 rename from terminal:** Clicking a tree terminal item intentionally focuses the terminal (`terminal.show()`). A second F2 keybinding with `"when": "terminalFocus"` covers the rename flow after focus moves. The `renameSession` handler falls back to `vscode.window.activeTerminal` when no arg is provided so the keybinding resolves the right terminal without a QuickPick.
- **Startup checks must be non-blocking:** `checkAgencyOnStartup` was using `execSync` which blocks the entire extension activation. Replaced with async `exec` callback. Any startup probe that shells out must use async execution to avoid freezing the activation path.
- **Cache user-facing prompts in globalState:** Toasts that fire on reload (like the agency update prompt) need dedup logic. Use `context.globalState` with a version+timestamp cache keyed by feature name. 24-hour cooldown prevents nagging while still re-checking after a reasonable interval or when the installed version changes.
- **User-facing text vs internal code:** When renaming user-facing strings (e.g. "squads" ‚Üí "agents"), only touch string literals shown to users ‚Äî status bar text, QuickPick placeholders, toast messages, and `package.json` view names. Leave internal variable names, function names, file names, and test fixture data unchanged. Squad-specific features (squad-upgrader) that reference the Squad CLI product keep "squad" in their messages.
- **Provider update infrastructure is generalized:** Update checking in `cli-provider.ts` is driven by optional `updateCommand`, `upToDatePattern`, and `updateRunCommand` fields on `CliProvider`. To add update support for a new CLI, just populate those fields in `KNOWN_PROFILES` ‚Äî no new functions needed. Cache keys are per-provider (`editless.${name}UpdatePrompt`). The old `checkAgencyOnStartup` still exists as a deprecated alias for `checkProviderUpdatesOnStartup`.
- **Terminal session persistence pattern:** `TerminalManager` persists terminal-to-squad mappings in `workspaceState` (key: `editless.terminalSessions`) and reconciles with live `vscode.window.terminals` on reload by matching `terminal.name`. The `TerminalInfo` interface stays unchanged ‚Äî a separate `PersistedTerminalInfo` serializes `Date` ‚Üí ISO string and adds `terminalName` for reconciliation. `_persist()` is called after every mutation (launch, close). `reconcile()` runs once after tree provider setup during activation.
- **Notification settings pattern:** Notifications use a master toggle (`notifications.enabled`) plus per-category booleans (`notifications.inbox`, `notifications.updates`). The shared `isNotificationEnabled(category)` helper in `notifications.ts` checks both ‚Äî master off kills all, otherwise defers to the category setting. New notification categories follow this same pattern: add a setting, pass the category key to the helper.
- **Agent discovery (#2 + #18):** Added `src/agent-discovery.ts` ‚Äî scans workspace `.github/agents/*.agent.md` and root-level `*.agent.md` files on activation, surfaces them in the tree view as read-only "Discovered Agents" section.
- **Add Agent / Add Squad buttons (#13):** Added `editless.addAgent` (creates `.github/agents/{name}.agent.md` template, re-runs discovery) and `editless.addSquad` (folder picker ‚Üí `git init` + `npx squad init` in a terminal) as header actions on the Agents pane.
- **Three-pane sidebar (#4):** Split sidebar into Agents, Work Items, and PRs collapsible views. Work Items and PRs are placeholder tree providers for future GitHub/ADO integration.
- **Launch from Work Item (#7):** Right-click context menu on work items shows a QuickPick of all registered agents/squads. Selecting one launches a terminal named after the issue, copies the issue URL to clipboard. Added optional `customName` parameter to `TerminalManager.launchTerminal`.
- **Plan Detection (#6):** Work item tree items now show plan status ‚Äî checks issue labels for "has plan", "has-plan", "plan", or "planned". Shows üìã for planned items and ‚ùì for items needing a plan, with description updated accordingly.
- **Work Item Type Filter (#17):** Added `editless.github.issueFilter` setting with `includeLabels` and `excludeLabels` arrays. Filtering is applied after fetching ‚Äî exclude hides matching issues, include restricts to matching issues, empty means show all.
- **Milestone Grouping (#10):** Issues with milestones are grouped under collapsible milestone headers in the Work Items tree. Issues without a milestone go under a collapsed "No Milestone" group. Falls back to flat list when no milestones exist.
- **Version Toasts (#51):** Update toasts now show both installed and available versions (e.g. "1.2.3 ‚Üí 1.3.0") when the available version can be parsed from the update command output. Falls back to current-only format when parsing fails.
- **Markdown Preview (#41):** Discovered agent `.md` files now open in VS Code's built-in markdown preview instead of the text editor. Added `editless.openFilePreview` command that delegates to `markdown.showPreview`.
- **PR Links (#33):** Added `editless.goToPR` context menu command on work items. Uses `gh pr list --search` to find PRs referencing the issue number. Single PR opens directly; multiple PRs show a QuickPick. Added `fetchLinkedPRs` to `github-client.ts`.
- **Settings schema polish (#88):** Added `markdownDescription`, `scope`, and `order` to all 11 settings. Added `enumDescriptions` and `enumItemLabels` to `cli.provider`. Order groups: Core (1‚Äì3), Notifications (10‚Äì12), CLI/Agent (20‚Äì22), GitHub (30‚Äì31). Scope: `resource` for workspace-specific paths/configs, `window` for user preferences. `discovery.scanPaths` was intentionally skipped (not in the plan's 11 settings).
- **Inline close button (#92):** Reused the existing `editless.closeTerminal` command ‚Äî added `"icon": "$(close)"` and an `inline@99` menu entry. No new command or handler needed. When an existing command already does what you need, just wire it into the UI layer (icon + menu placement).
- **Async CLI probing + custom provider (#107, #109):** Replaced `execSync` with async `exec` in `probeCliVersion()` to eliminate 15s activation freeze. `probeAllProviders()` is now async, called fire-and-forget from `activate()` with `resolveActiveProvider()` chained via `.then()`. Added `custom` profile to `KNOWN_PROFILES` with empty command/versionCommand for presence-only detection. `resolveActiveProvider()` now honors explicit `custom` setting without requiring a probe. Updated all tests for async flow. PR #121.
- **P1 code quality fixes (#114, #116, #117, #119):** Four mechanical fixes batched into one PR. (1) Added `getLastActivityAt()` public getter to `TerminalManager` to replace bracket-notation private field access in `editless-tree.ts`. (2) Stored the leaked `labelManager.onDidChange()` subscription, added `dispose()` to `EditlessTreeProvider` implementing `vscode.Disposable`, pushed provider to `context.subscriptions`. (3) Removed 4 dead prototype types from `types.ts` (`TerminalSession`, `DashboardState`, `WebSocketMessage`, `LaunchRequest`) ‚Äî zero imports anywhere. (4) Removed unused `promptRenameSession` export from `session-labels.ts`. All 200 tests pass, tsc clean. PR #124.
- **Remove custom commands feature (#131):** Removed `editless.customCommands` setting, `editless.runCustomCommand` command + handler, context menu entry, `CustomCommandEntry` interface, and `custom-commands.test.ts`. Updated `custom` CLI provider enum description to not reference the removed feature. Updated `docs/SETTINGS.md`. The `editless.agentCreationCommand` setting (separate feature) was intentionally preserved ‚Äî its local variable `customCommand` is unrelated naming. 340 tests pass, tsc clean. PR #134.
- **Deep-link configure buttons (#102):** Work Items and PRs tree views now show two configure links when no repos are set: "Configure in GitHub" (opens settings filtered to `editless.github`) and "Configure in ADO" (opens settings filtered to `editless.ado`). Added `editless.ado.organization` and `editless.ado.project` settings as foundation for future ADO integration. Registered `editless.configureAdo` command. Widened GitHub filter from `editless.github.repos` to `editless.github` to show all GitHub settings. 349 tests pass, tsc clean. PR #138.
- **Session status: working vs waiting-on-input (#133):** Split the generic `active` SessionState into `working` (shell execution in progress) and `waiting-on-input` (execution finished, user needs to respond). `getStateIcon` maps working‚Üí`loading~spin`, waiting-on-input‚Üí`bell-dot`. Detection: `shellExecutionActive=true` ‚Üí working; recent activity but no execution ‚Üí waiting-on-input; beyond idle threshold ‚Üí idle/stale as before. `needs-attention` does NOT override `working` (per team decision). `editless-tree.ts` needed no changes ‚Äî it delegates to helper functions. 348 tests pass, tsc clean. PR #137.
- **PR merge conflict indicator (#129):** Added `mergeable` field to `GitHubPR` interface and `fetchMyPRs`/`fetchLinkedPRs` queries. PRs with `mergeable === 'CONFLICTING'` show a `warning` ThemeIcon (with `list.warningForeground` color), `‚ö†Ô∏è has conflicts` in the description, and a conflict warning in the tooltip. UNKNOWN/empty states are handled gracefully (no indicator). 6 new tests, 354 total pass, tsc clean. PR #136.
- **Background terminal on squad add (#127):** Added `hideFromUser: true` to `createTerminal` options in `editless.addSquad` command and removed `terminal.show()`. Only the squad init/upgrade terminal is hidden ‚Äî `launchTerminal` in `terminal-manager.ts` and `addAgent` custom-command terminal remain user-visible since they're explicitly user-initiated. 348 tests pass, tsc clean. PR #135.
- **Terminal layout restore (#40):** Added `TerminalLayoutManager` in `src/terminal-layout.ts` ‚Äî listens to `onDidChangeVisibleTextEditors` and fires `workbench.action.toggleMaximizedPanel` when all editors close after being opened from a no-editor state. Tracks `hadVisibleEditors` and `panelWasMaximized` to avoid false triggers. Added `editless.restoreTerminalLayout` boolean setting (default: true, order: 4, scope: window). Setting is read live on each event so it can be toggled mid-session. 7 new tests, 354 total pass, tsc clean. PR #142.
- **Persistent upgrade indicator (#91):** Squad items now show `upgrade available` in their description when the local Squad CLI version is older than the latest on GitHub. Added `getLatestSquadVersion()` (HTTPS fetch from `raw.githubusercontent.com`, cached 1hr), `isNewerVersion()` semver comparison, and `checkSquadUpgradesOnStartup()` in `squad-upgrader.ts`. Tree provider stores upgrade state in `_upgradeAvailable` map; sets `contextValue` to `squad-upgradeable` for upgradeable squads. Inline upgrade button now only shows for squads with available upgrades (`viewItem == squad-upgradeable`); other squad menus use regex match (`viewItem =~ /^squad/`). Indicator clears after upgrade completes via `onUpgradeComplete` callback. 7 new tests (isNewerVersion + tree indicator), 358 total pass, tsc clean. PR #145.
- **Tree UX: click to expand, + button for new session (#144):** Removed `command` property from squad tree items so clicking expands/collapses (standard VS Code tree behavior) instead of launching a terminal. Added `$(add)` inline button on squad and agent nodes via `view/item/context` menu contribution with `viewItem =~ /^squad|^agent$/`. Updated `editless.launchSession` handler to accept both `string` (squadId) and `EditlessTreeItem` arguments. Agent items now carry `squadId` so the inline button resolves the correct squad. 368 tests pass, tsc clean. PR #147.
- **Work items plan icon fix (#139):** `buildIssueItem()` in `src/work-items-tree.ts` had a binary planned/not-planned check that didn't recognize `status:planned` or `status:needs-plan` GitHub labels. Replaced with ternary logic: planned (üìã, matches `status:planned` + legacy labels), needs-plan (‚ùì, matches `status:needs-plan`), and neutral (‚Äî, no plan label). Tooltip and description update accordingly. Created `src/__tests__/work-items-tree.test.ts` with 15 tests covering all label variants, case-insensitivity, and precedence when both labels present. 383 tests pass, tsc clean.
- **Squad folder rename backward compat (#93):** Created `src/team-dir.ts` with `resolveTeamDir()`, `resolveTeamMd()`, and `TEAM_DIR_NAMES` constant. The utility checks `.squad/` first (new Squad CLI convention), then `.ai-team/` (legacy fallback). Updated `discovery.ts`, `scanner.ts`, `squad-upgrader.ts`, and `watcher.ts` to use the utility instead of hardcoded `.ai-team` paths. Error messages now say `.squad/ (or .ai-team/)`. Created `src/__tests__/team-dir.test.ts` (12 tests). Added `.squad/` tests to discovery and scanner test suites. 409 tests pass, tsc clean.
- **Session persistence for crash recovery (#94):** Added `agentSessionId` and `launchCommand` optional fields to both `TerminalInfo` and `PersistedTerminalInfo`. `launchCommand` is captured from `AgentTeamConfig` during `launchTerminal()` and persisted to `workspaceState`. `relaunchSession()` now sends the persisted `launchCommand` (or `launchCommand --resume <agentSessionId>` when a session ID exists) instead of creating a silent terminal. Added `setAgentSessionId()` public method for external session ID association. All new fields flow through reconcile, reconnect, and persist paths. The `deactivate()` handler already called `persist()` ‚Äî no change needed there. 14 new tests, 409 total pass, tsc clean.

üìå **Team update (2026-02-16):** v0.1 Release Triage & Scope Lock ‚Äî #148 (session labels off by one) triaged as P0 and assigned to you. 7 P0 items locked for v0.1, 8 P1 items prioritized, 5 items cut to post-v0.1. Scope lock: no new v0.1 items after 15:00 UTC. ‚Äî decided by Rick

üìå **Team update (2026-02-16):** Session State Design Issue ‚Äî `waiting-on-input` misclassification documented as a P2 design issue in decisions.md. Investigation revealed that the heuristic conflates "recent activity" with "waiting for user input" and has no positive signal to distinguish legitimate input-waiting scenarios. Fix requires inverting the default to `idle` and introducing a separate `_waitingOnInput` signal or terminal output parsing. Filed as issue #226. ‚Äî investigated by Morty
- **Session state `waiting-on-input` misclassification (investigation):** `getSessionState()` in `terminal-manager.ts:336-365` defaults to `waiting-on-input` for any terminal with `_lastActivityAt` within the 5-minute idle threshold and no active shell execution. This means every terminal shows `waiting-on-input` for up to 5 minutes after any command finishes ‚Äî even when idle. Root cause is a design issue: `onDidEndTerminalShellExecution` (line 86-89) sets both `_shellExecutionActive=false` and `_lastActivityAt=Date.now()`, but there is no positive signal distinguishing "agent asking a question" from "command finished normally." The reconcile path (line 449) restoring `_lastActivityAt` from `persisted.lastSeenAt` amplifies this on reload. Fix requires inverting the default to `idle` and introducing a separate positive signal for `waiting-on-input`.
- **Filter category grouping (#213):** The work items filter now groups active filters by their label prefix (everything before the colon). Within each prefix group (e.g., `release:`), filters use OR logic. Across different prefix groups (e.g., `type:` + `release:`), filters use AND logic. This lets you say "show me docs OR bugs from v0.1 OR backlog" by selecting `type:docs`, `type:bug`, `release:v0.1`, `release:backlog`. The pattern is implemented in a private `matchesLabelFilter()` helper that groups by prefix, checks OR within each group, and AND across groups.
- **Upgrade All button context key (#228):** The "Upgrade All Squads" button now uses a context key `editless.squadUpgradeAvailable` to gate visibility instead of always showing when the Agents view is active. VS Code's TreeView API doesn't support dynamic menu visibility based on tree contents, so we use `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()` to track whether any squad has an upgrade available. The `onUpgradeComplete` callback re-runs the check to update the context key. The per-squad inline button already used `viewItem == squad-upgradeable`, now both buttons are gated consistently.



üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå Team update (2026-02-18): v0.2 quality gates established ‚Äî decided by Rick

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-18):** Worktree Dev Launcher as Primary Workflow ‚Äî scripts/dev-worktree.ps1 is now the recommended primary workflow for EditLess feature development. One command creates worktree, installs deps, builds, and launches isolated VS Code. .vscode/mcp.json example removed (EditLess doesn't use webviews). docs/local-development.md updated. All team members should use dev-worktree.ps1 for issue-based feature work. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-18):** EditLess Dev Workflow Skill Created ‚Äî Documented scripts/dev-worktree.ps1 in .ai-team/skills/editless-dev-workflow/SKILL.md with parameters, usage, branch naming conventions, and integration notes. Ensures agents discover and use the optimized workflow immediately without falling back to bootstrap tools or manual git commands. ‚Äî decided by Morty


üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-19):** Squad‚ÜîCopilot integration research ‚Äî Squanchy and Jaguar completed research on integration opportunities. Identified 14 Squad framework integration points and 7 Copilot API scenarios. Key data shape contracts documented for extension development (AgentDetail, DecisionInboxState, OrchestrationEntry). Watcher enhancement needed: pass changed file path to callback for per-file-type reactions. See decisions.md for full design. ‚Äî documented by Scribe

üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå **Team update (2026-02-19):** Terminal integration research session complete ‚Äî 4-phase architecture plan and 27-item priority matrix. Session log at .ai-team/log/2026-02-19-terminal-integration-research.md. ‚Äî documented by Scribe


üìå **Team update (2026-02-20):** CLI provider abstraction removed, inlined as direct settings (editless.cli.command/launchCommand/createCommand). Removed src/cli-provider.ts module entirely. Eliminated startup probing blocking activation. ‚Äî decided by Morty

üìå **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Removed time-based thresholds (IDLE_THRESHOLD, STALE_THRESHOLD) and events.jsonl parsing. New signal: shell execution tracking only. State icons: active=loading~spin, inactive=circle-outline, orphaned=eye-closed. Reduced code ~190 lines (prod+test). ‚Äî decided by Morty


üìå Team update (2026-02-19): Session rename & resume architectural decisions finalized. Key decisions: (1) Display dual names (EditLess + Copilot summary), (2) Fix #277 with TerminalOptions, (3) Create custom Copilot Sessions tree view, (4) No write-access to workspace.yaml. ‚Äî decided by Casey Irvine

## Learnings

- **CLI provider abstraction removed (#312):** Deleted `src/cli-provider.ts` (114 lines) and replaced the generic multi-provider infrastructure with direct inline settings. The abstraction had no purpose ‚Äî there was only one provider (Copilot CLI), no UI to switch providers, and the version detection probing via `execSync` was blocking activation. Added three simple settings: `editless.cli.command` (binary name), `editless.cli.launchCommand` (session launch template with `$(agent)` placeholder), and `editless.cli.createCommand` (agent creation command, empty = use built-in flow). All consumers (`extension.ts`, `discovery.ts`, `terminal-manager.ts`) now read settings directly via a thin `getLaunchCommand()` helper. Tests were updated to mock `vscode.workspace.getConfiguration()` instead of the removed provider module exports. The `createCommand` logic in `editless.addAgent` was simplified ‚Äî replaced "provider" with "cli" mode label and removed all references to `CliProvider` interface. This pattern should be applied to any future "provider" abstractions if there's only a single implementation and no need for runtime switching.
- **Review follow-up cleanup (PR #356):** Extracted `getLaunchCommand()` from 3 files (discovery.ts, extension.ts, terminal-manager.ts) into shared `src/cli-settings.ts`. Removed dead imports (fs, path, TEAM_DIR_NAMES) from work-items-tree.ts left behind by plan detection removal. Fixed 5 stale `'idle'` mock values ‚Üí `'inactive'` in tree-providers.test.ts after session state simplification. Note: scanner.ts `SquadStatus` still has a valid `'idle'` state ‚Äî that's a different concept from `SessionState`.


- **Refresh button squad discovery fix (#317, PR #364):** The `editless.refresh` command handler in `src/extension.ts` only called `discoverAllAgents()` for standalone `.agent.md` files ‚Äî it never triggered squad discovery. Added `autoRegisterWorkspaceSquads(registry)` and `checkDiscoveryOnStartup(context, registry)` to the refresh handler, plus `squadWatcher.updateSquads()` and `statusBar.update()` to keep derived state in sync. Pattern matched the workspace file watcher at lines 148-152. All 569 tests pass with no new test needed (existing discovery tests cover the called functions).
- **Extracted shared launch helper to eliminate duplication (#337):** Created `src/launch-utils.ts` with `MAX_SESSION_NAME` constant (50), `buildSessionName()` function for name truncation logic (truncates at last space before limit or at limit if no space, appends ellipsis), and `launchAndLabel()` function that orchestrates terminal launch + label assignment. Replaced 12 identical lines in both `launchFromWorkItem` and `launchFromPR` handlers in extension.ts with calls to `launchAndLabel()`. Both callers pass the appropriate raw name format: work items use `#${number} ${title}`, PRs use `PR #${number} ${title}`. Added comprehensive tests (14 test cases) covering short names, long names with/without word boundaries, ellipsis formatting, and real-world scenarios. All 774 tests pass. This extraction pattern should be applied to any future duplication of terminal launch logic across commands.

- **Session resume fix (#322, PR #365):** The resume flow in `relaunchSession()` had a race condition ‚Äî `terminal.show()` was called before `terminal.sendText()`, meaning the command fired before the shell was ready. Fix: call `sendText()` before `show()` to queue the command. Added `isSessionResumable()` on `SessionContextResolver` that validates `workspace.yaml` + `events.jsonl` exist in `~/.copilot/session-state/{id}/` before resume. Stale session warning (>7 days) uses `fs.statSync(eventsPath).mtimeMs`. `TerminalOptions.env` now passes `EDITLESS_SESSION_ID` and `EDITLESS_AGENT_SESSION_ID`. Added `continueLatest` param to `relaunchSession()` for `--continue` flag support. Key pattern: always sendText before show for terminal commands.

üìå **Unified discovery implementation (PR for #317/#318, 2026-02-21):** Created `src/unified-discovery.ts` with `DiscoveredItem` interface (`{ id, name, type: 'agent'|'squad', source, path, description?, universe? }`) and `discoverAll(workspaceFolders, registry)` that scans workspace folders for both agents AND squads in one pass, plus `~/.copilot/agents/` for personal library. Tree view updated: 'Discovered' section replaces 'Discovered Agents', shows count badge, squads first then agents. `discovered-squad` is new TreeItemType. Removed toast-based `checkDiscoveryOnStartup()`. Refresh triggers unified re-discovery. Deprecated `editless.discoveryDir` and `editless.discovery.scanPaths` settings. 10 new tests, 579 total pass. ‚Äî implemented by Morty

üìå **Pseudoterminal spike assessment (#321, 2026-02-21):** Analyzed the spike branch (`squad/321-pseudoterminal-spike`) vs master at Casey's request. Key finding: `copilot-pseudoterminal.ts` (264 lines, 30 tests) is a standalone module never wired into `terminal-manager.ts`, `editless-tree.ts`, or `extension.ts`. The `terminal-manager.ts` files are byte-for-byte identical on both branches. The spike's 5-state model (starting/idle/working/waiting/closed) and session ID regex (`/Session ID:\s*([a-f0-9-]+)/i`) exist only in isolation. Casey correctly observed no status changes ‚Äî they can't happen without integration. Session ID regex depends on CLI printing "Session ID:" which Casey reports no longer occurs. Master's filesystem-based detection (`SessionContextResolver`) is more robust. Assessment filed to `.squad/decisions/inbox/morty-pseudoterminal-assessment.md`. ‚Äî assessed by Morty

- **ACP Process Pool (M5a/M5b, #370):** Created `src/acp/process-pool.ts` ‚Äî a `ProcessPool` class that manages concurrent child processes via `child_process.spawn()` (not VS Code terminals). Tracks stdout/stderr buffers per process, supports incremental reads (getOutput clears buffer), waitForExit via stored Promise, and Windows-safe tree kill (`taskkill /T /F /PID`). Implements `vscode.Disposable` for orphan cleanup. Wired into `DefaultAcpRequestHandler` ‚Äî all terminal stubs replaced with pool calls, `onWriteTextFile` now writes to disk with auto-mkdir. Handler implements `Disposable`; `extension.ts` calls `handler.dispose()` in the panel cleanup path to avoid orphaned processes. Build + tsc pass clean.

üìå **Phase 2 terminal integration review (2026-02-21):** Reviewed terminal-manager.ts and session-context.ts for Phase 2 implementation. **Verdict: APPROVE with 2 advisory notes.** Findings: (1) `relaunchSession()` (terminal-manager.ts:304-308) shows error message when session is non-resumable but still proceeds to create the terminal and send the command ‚Äî this is intentional soft validation, but worth noting that the CLI will fail anyway if state is corrupted. (2) `watchSession()` retry loop in session-context.ts:218-224 has no max-retry cap ‚Äî if events.jsonl never appears, `setupWatch()` retries every 1s indefinitely until dispose() is called. In practice this is bounded by terminal lifetime (onDidCloseTerminal disposes the watcher), but a retry cap (e.g., 30 attempts) would be defensive. (3) `fs.watch` with `{ persistent: false }` is correct ‚Äî won't keep the Node process alive. (4) VS Code API usage is correct: `isTransient: true` prevents zombie terminals, `iconPath: new ThemeIcon('terminal')` is valid, env vars are properly typed. (5) sendText-before-show pattern correctly maintained in all 3 code paths (launch, reconnect, relaunch). (6) Resource cleanup is thorough ‚Äî onDidCloseTerminal cleans watchers, dispose() clears all maps and timers. (7) No `any` leaks in production code. (8) 137 tests all pass. ‚Äî reviewed by Morty

üìå **Phase 2 watcher lifecycle tests (revision, 2026-02-21):** Added 6 tests per Meeseeks' review request. In `terminal-manager.test.ts` (5 tests in `Phase 2: watcher lifecycle` describe): (1) launchTerminal calls `watchSession` with pre-generated UUID, (2) watcher disposed on terminal close via `capturedCloseListener`, (3) `dispose()` clears all session watchers across 2 terminals, (4) `reconnectSession`+`relaunchSession` both wire watchers when `agentSessionId` present, (5) custom `config.launchCommand` branch appends `--resume UUID`. In `session-context.test.ts` (1 test in `watchSession malformed JSON` describe): corrupt last line in events.jsonl handled gracefully ‚Äî callback not called. Pattern: local `makeMockResolver()` helper with `watchSession`/`watchSessionDir` stubs; `as any` cast for `setSessionResolver`; template literal UUID type cast. ‚Äî written by Morty

- **Bump terminal constants (#328):** Changed 4 constants and added 4 event types across 2 source files. In `session-context.ts`: `EVENT_CACHE_TTL_MS` 3s‚Üí10s (reduces disk I/O from events.jsonl reads), `STALE_SESSION_DAYS` 7‚Üí14 (sessions stay resumable longer). In `terminal-manager.ts`: `MAX_REBOOT_COUNT` 2‚Üí5 (orphaned sessions survive more VS Code restarts before eviction), added `assistant.thinking`, `assistant.code_edit`, `tool.result`, `session.resume` to `isWorkingEvent()` switch (catches more active-agent event types). Tests updated: stale test uses 15-day-old mtime (was 10), reboot eviction test uses rebootCount=4 (was 1). IDLE_THRESHOLD_MS and STALE_THRESHOLD_MS were already removed in PR #354 (session state simplification). 633 tests pass, build clean.

üìå **Hierarchical work items tree with per-level filtering (#390, 2026-02-23):** Implemented cascading tree hierarchy for work items view where filter options at each level correspond to direct children of that node. GitHub hierarchy: GitHub ‚Üí Owner ‚Üí Repo ‚Üí Issues (with milestone grouping). ADO hierarchy: Azure DevOps ‚Üí Org ‚Üí Project ‚Üí Work Items (with parent/child). Added inline filter icons on group nodes that open scoped QuickPick with only relevant options (e.g., ADO project shows Type/State/Tags, GitHub repo shows Labels/State). Filter state displayed in node descriptions. Tree auto-collapses when only one backend or repo configured for clean UX. New commands: editless.filterLevel (opens scoped filter for clicked node), editless.clearLevelFilter (clears specific level filter). Global filter (editless.filterWorkItems) kept as fallback. Key implementation: LevelFilter interface with per-node filtering, _levelFilters Map keyed by node ID, getAvailableOptions() returns context-aware options, _getFilterDescription() shows active filters in node descriptions. contextValue pattern for menu contributions: ado-backend, ado-org, ado-project, github-backend, github-org, github-repo. Menu regex: viewItem =~ /^(ado|github)-(backend|org|project|repo)$/ for inline actions. All 700 tests pass.


üìå **Hierarchical PR tree with per-level filtering (#390, 2026-02-23):** Applied the same cascading hierarchy pattern from work items to the Pull Requests tree. GitHub PR hierarchy: GitHub ‚Üí Owner ‚Üí Repo ‚Üí PRs. ADO PR hierarchy: Azure DevOps ‚Üí Org ‚Üí Project ‚Üí PRs. Added PRLevelFilter interface with statuses/labels/selectedChildren. Added _levelFilters Map, getLevelFilter/setLevelFilter/clearLevelFilter/clearAllLevelFilters, getAvailableOptions() returning scoped options per context level, and _applyGitHubLevelFilter/_applyAdoLevelFilter for per-node filtering. Key difference from work items: PRs use statuses (draft/open/approved/changes-requested/auto-merge) instead of states+types, and use github-pr-* / ado-pr-* context values (not github-* / ado-* which are taken by work items). Global filterPRs command trimmed to sources-only. New commands: editless.filterPRLevel, editless.clearPRLevelFilter. Menu regex: viewItem =~ /^(ado|github)-pr-(backend|org|project|repo)$/. Author toggle preserved as orthogonal to hierarchy. clearPRsFilter also calls clearAllLevelFilters(). prsProvider.setAdoConfig() wired in initAdoIntegration. All 700 tests pass, build clean.

üìå **Level filter key mismatch pattern (#390, 2026-02-23):** Tree node IDs include `:f{seq}` suffixes that change on every `_filterSeq` increment. Level filters must be stored and looked up using clean IDs (stripped via `_cleanNodeId()`). Any future code that stores data keyed by tree node IDs must strip the filter sequence suffix first.

üìå **Filtered contextValue suffix pattern (#390, 2026-02-23):** Group nodes with active level filters append `-filtered` to their `contextValue`. The `getChildren()` dispatch and `getAvailableOptions()` strip this suffix before matching. Menu `when` clauses use `(-filtered)?$` regex to match both states. The clear icon only shows on `-filtered` variants.

üìå **Default exclusion of closed/merged items (#390, 2026-02-23):** `applyRuntimeFilter` excludes closed work items and merged/closed PRs by default when no state/status filter is active. The same logic applies in level filter methods. Tests needing closed/merged items must explicitly set the filter.


üìå **Inline icons + ADO launch support (#337, 2026-02-23):** Added inline play-button icons for `launchFromWorkItem` and `launchFromPR` in `view/item/context` using `group: inline@10` (after existing inline actions). Updated all context menu `when` clauses to use regex matching for ADO variants: `viewItem =~ /^(work-item|ado-work-item|ado-parent-item)$/` and `viewItem =~ /^(pull-request|ado-pull-request)$/`. The `launchFromWorkItem` command now handles `item?.adoWorkItem` mirroring the existing `launchFromPR` ADO pattern. Both commands already had `icon: "$(play)"`.

üìå **CWD-indexed session cache (#331, 2026-02-21):** Replaced linear `_scan()` in `SessionContextResolver` with a CWD-indexed lookup. New `_ensureIndex()` method builds a `Map<normalizedCWD, CwdIndexEntry[]>` on first scan, reuses it on subsequent calls if the session-state directory count hasn't changed. `_scan()` now does O(1) map lookups per squad path instead of reading every workspace.yaml. `clearCache()` clears both the per-call cache and the CWD index. Invalidation: directory count change triggers full rebuild. Performance: 200-session indexed lookup completes in <5ms (vs ~100ms linear scan). Files: `src/session-context.ts` (CwdIndexEntry interface, _cwdIndex/_indexedDirCount fields, _ensureIndex() method, refactored _scan()), `src/__tests__/session-context.test.ts` (200-session perf test, index invalidation test). ‚Äî implemented by Morty
üìå **Built-in default Copilot CLI agent (#337, 2026-02-22):** The tree always shows a 'Copilot CLI' entry (id: `builtin:copilot-cli`, type: `default-agent`) at the top of the root items. It launches the generic `copilot` CLI without `--agent` flag by setting `launchCommand` to `getCliCommand()`. Uses a synthetic `AgentTeamConfig` created in the `launchSession` handler (not stored in registry). The `contextValue: 'default-agent'` ensures it gets the launch inline icon but NOT delete/edit/hide actions. Replaces the old empty-state welcome items. The default agent is never hidden by the visibility manager. ‚Äî decided by Morty

üìå **Universe auto-detection from registry.json (#393, 2026-02-23):** Added `readUniverseFromRegistry(squadPath)` in `discovery.ts` that reads `.squad/casting/registry.json` (or `.ai-team/casting/registry.json`) and returns the universe of the first active agent. Called as a fallback in `discoverAgentTeams()`, `autoRegisterWorkspaceSquads()`, and `unified-discovery.ts:discoverAll()` when `parseTeamMd()` returns universe='unknown'. Detection priority: (1) team.md `**Universe:**` marker, (2) casting registry.json, (3) 'unknown'. `parseTeamMd` kept pure ‚Äî only parses text, no filesystem access. 9 new tests cover the helper and the integration fallback. ‚Äî decided by Morty

üìå **PR review fix batch ‚Äî v0.1.1 test consolidation (2026-02-22):** Fixed 5 items from Rick's PR review rejection. (1-2) Updated work-items-tree.test.ts and prs-tree.test.ts to use shared createVscodeMock() factory from mocks/vscode-mocks.ts instead of inline vscode mocks (~40 lines each ‚Üí single import). Pattern: kept domain-specific mocks (GitHub/ADO clients, fs) intact, only replaced TreeItem/ThemeIcon/EventEmitter/etc. (3) Added iconPath assertions to work-items-tree.test.ts ‚Äî new test suite validates ThemeIcon('issues') for GitHub issues, ThemeIcon('azure') for ADO items. (4) Added empty string edge case to launch-utils.test.ts (uildSessionName('') ‚Üí ''). (5) Fixed real path calculation bug in unified-discovery.ts line 120 ‚Äî filter assumed all squad.agent.md files are 3 levels deep ({root}/.github/agents/squad.agent.md), but workspace root agents are 1 level deep ({root}/squad.agent.md). Fixed with conditional depth check based on parent directory names. All tests pass (776/777, 1 unrelated flaky perf test). ‚Äî fixed by Morty

üìå **ADO single-backend hierarchy bug fix (v0.1.1 dogfood, 2026-02-24):** Fixed bug where filtering to only ADO via Show/Hide Sources collapsed the org->project hierarchy into flat work items. Root cause in work-items-tree.ts getChildren(): when backendCount===1, the ADO path called _getAdoRootItems() (flat list) instead of _getAdoOrgNodes() (hierarchy). One-line fix: changed line 366 from _getAdoRootItems(filteredAdo).map(...) to _getAdoOrgNodes(filteredAdo). Updated 12 existing tests that assumed flat ADO items at root - they now call setAdoConfig('org','project') and navigate through org->project to reach items. Added 2 new tests: single-backend ADO hierarchy and source-filter-hides-GitHub scenario. Key pattern: ADO-only tests MUST call setAdoConfig() before setAdoItems(), otherwise _getAdoOrgNodes returns [] because _adoOrg is undefined. - fixed by Morty
üìå **Reconciliation timing race fix (2026-02-23):** `reconcile()` sets up a debounced `onDidOpenTerminal` listener (200ms) for late-arriving terminals, but extension.ts was checking `getOrphanedSessions()` synchronously ‚Äî before the debounce could fire. Fix: added `waitForReconciliation()` returning a Promise that resolves when all `_pendingSaved` entries are matched OR after a 2s max timeout. `_tryMatchTerminals()` resolves the promise early when `_pendingSaved` empties. Extension.ts now defers the orphan toast behind this promise. Pattern: any code that reads `_pendingSaved` after `reconcile()` should await `waitForReconciliation()` first. ‚Äî fixed by Morty


üìå **Parallel tool call detection for ask_user (#402):** Copilot CLI emits tool calls in parallel, so the last event in events.jsonl may NOT be the ask_user start ‚Äî it could be a report_intent completion. Fix: `getLastEvent()` and `watchSession()` now parse ALL tail lines (not just the last line) and track open ask_user calls via a `Set<string>` of toolCallIds. New `hasOpenAskUser` boolean field on `SessionEvent` is the signal for `isAttentionEvent()`. This replaces the old approach of checking `event.type === 'tool.execution_start' && event.toolName === 'ask_user'`. 898 tests pass. Commit: d41725a. ‚Äî Morty

üìå **ADO config change watcher (PR #424, #417):** `initAdoIntegration()` in `src/extension.ts` is now re-called when `editless.ado.organization` or `editless.ado.project` settings change, via an `onDidChangeConfiguration` handler registered in `activate()`. Pattern: any integration that reads config at init time needs a config change watcher to avoid stale state. Key file: `src/extension.ts` ~line 1000. 910 tests pass. Commit: 372d350. ‚Äî Morty

üìå **Config-change handlers for all integrations (PR #424, #417):** Both ADO and GitHub integrations in extension.ts now have `onDidChangeConfiguration` handlers so settings changes take effect without reload. ADO handler (already existed) watches `editless.ado.organization` and `editless.ado.project`; new GitHub handler watches `editless.github.repos`. Pattern: `context.subscriptions.push(vscode.workspace.onDidChangeConfiguration(e => { if (e.affectsConfiguration('editless.xxx')) initXxxIntegration(...); }))` near the initial init calls in `activate()`. New test file `config-refresh.test.ts` covers both handlers + unrelated-change-ignored case. 914 tests pass. Commit: 52f0102. ‚Äî Morty