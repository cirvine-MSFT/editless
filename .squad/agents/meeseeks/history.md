# Project Context

- **Owner:** Casey Irvine
- **Project:** EditLess â€” a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings

- **2026-02-21 â€” Auto-discover refactor test migration (#399):** Fixed 191 test failures across 6 files after Morty's auto-discover refactor (registryâ†’agentSettings). Key changes: (1) Deleted `registry.test.ts` and `visibility.test.ts` â€” tested deleted modules. (2) Created `agent-settings.test.ts` â€” 26 tests covering AgentSettingsManager CRUD, visibility (hide/show/showAll/getHiddenIds), reload, disk persistence, migrateFromRegistry. Uses real temp dirs, not mocks. (3) `extension-commands.test.ts` â€” replaced all registry/visibility hoisted mocks with agentSettings mocks, rewrote command handler tests for new APIs (agentSettings.get/update instead of getSquad/updateSquad, discoveredItems instead of loadSquads, hide/show toggle for squad-hidden type, launchAndLabel mock separated from terminalManager.launchTerminal). Added `fs` partial mock (existsSync intercepts agent-registry.json only), `createFileSystemWatcher` to vscode workspace mock, `setDiscoveredItems` to status bar mock, `globalStorageUri`/`extensionPath` to makeContext(). (4) `tree-providers.test.ts` â€” replaced all `createMockRegistry(squads)` with `createMockAgentSettings(squads)` + `provider.setDiscoveredItems(toDiscovered(squads))`. Removed visibility 5th param. Rewrote "Discovered" section tests (no more header, items are inline root items). Hidden items now appear with type `squad-hidden`, not excluded. (5) `config-refresh.test.ts` â€” replaced registry/visibility/agent-discovery mocks with agent-settings mock, added fs/launch-utils/createFileSystemWatcher mocks. (6) `unified-discovery.test.ts` â€” removed registry param from discoverAll calls, updated 3 exclusion tests to inclusion. **Mock pattern insight:** `vi.clearAllMocks()` does NOT reset `mockReturnValue` â€” must explicitly reset in beforeEach (e.g., `mockDiscoverAll.mockReturnValue([])`). Final: 899 tests passing, 0 failures across 28 files.
- **2026-02-26 â€” PR #424 Test Coverage Review â€” 3x Review Cycle (APPROVED âœ…):** Config refresh test coverage for ADO/GitHub integration re-initialization. Initial review: REQUEST CHANGES due to missing edge case tests, no async race condition coverage, no debounce testing. Issues identified: (1) Empty/invalid config values not tested, (2) No async race condition coverage for concurrent init calls, (3) Rapid successive changes fire N API calls for N keystrokes (no debounce), (4) Auth state interaction not tested, (5) Test helper `findConfigHandlers` only checks positive behavior, not negative (ignores unrelated keys). After Morty's fix: Added edge case tests (empty config values, invalid inputs, rapid successive changes), debounce testing with `vi.useFakeTimers()` + `vi.advanceTimersByTime(500)`, negative behavior verification (handler ignores unrelated config keys). Final result: 918 tests passing, all edge cases covered. **Key testing pattern:** When testing event handlers, verify both positive (responds to target key) and negative (ignores unrelated keys) behavior explicitly. Use fake timers for debounce testing. Test async race conditions by triggering rapid successive changes and verifying single execution after debounce delay. Decision merged: Config Refresh Test Coverage patterns.

- **2026-02-20 â€” Hierarchical filter test coverage (#390):** Added 46 tests (24 work-items-tree, 22 prs-tree) covering level filter infrastructure. Key patterns: **LevelFilter lifecycle** â€” test get/set/clear/clearAll with event firing, verify undefined on missing keys. **getAvailableOptions()** â€” test all contextValue paths (github-backend, github-org, github-repo, ado-backend, ado-org, ado-project, and PR equivalents), verify correct option extraction (owners, repos, orgs, projects, types, labels, tags, states, statuses). **Hierarchy rendering with filters** â€” test getChildren() behavior when level filters applied to repo/project nodes, verify filter cascade (labels+states, types+tags+states, statuses+labels), test AND-across-groups label logic. **Edge cases** â€” test empty results when filter matches nothing, single backend configurations (GitHub-only, ADO-only), mixed backend (both GitHub and ADO). Commands not tested directly â€” extension-commands.test.ts already has mocks in place but no execution tests for filterLevel/filterPRLevel/clearLevelFilter/clearPRLevelFilter (noted as future P1 gap). Total: 746 tests passing (up from 700).

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ **Team update (2026-02-16):** Documentation animation strategy â€” EditLess uses optimized GIFs stored in docs/media/ directory. Primary tool: ScreenToGif (Windows). Files must be <1 MB, max 800px width, 3â€“8 seconds duration. File naming is descriptive kebab-case (e.g., planning-feature.gif). Re-recording triggers documented: UI structure changes, command/shortcut changes, label changes, layout changes. Team reviews animations on code review checklist. â€” decided by Summer

ğŸ“Œ **Team update (2026-02-19):** User directive â€” Delete squad-upgrader.ts entirely â€” squad-upgrader.ts and its tests will be deleted entirely (not kept for utilities). The 4 kept functions (checkNpxAvailable, promptInstallNode, isSquadInitialized, getLocalSquadVersion) will be extracted to squad-utils.ts. This overrides prior Rick design review (#303) decision to keep the file name. Update test expectations accordingly when squad-utils is created and squad-upgrader tests are deleted. â€” directed by Casey Irvine

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ **Team update (2026-02-16):** Default release target â€” All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. â€” decided by Casey Irvine

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ğŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ğŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ğŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).
- **2026-02-19 â€” PR #320 review (terminal-layout removal, #309):** Reviewed Morty's feature removal PR. Checklist for feature removal test cleanup: (1) delete dedicated test file, (2) remove all `vi.mock` declarations for the deleted module from every test file that imports `extension.ts`, (3) grep entire `src/` for the module name, class name, and setting name, (4) verify test count drops only by the deleted file's count and no other tests break. This PR was clean â€” `vi.mock('../terminal-layout', ...)` removed from `auto-refresh.test.ts` and `extension-commands.test.ts`, zero residual references, all 630 tests pass across 27 files. No coverage gap since the deleted tests only tested the deleted module. Total tests: 630 (down from ~640 due to deleted terminal-layout.test.ts with ~10 tests).
- **2026-02-20 â€” Batch test coverage review of 4 removal PRs (#312, #302, #306, #311):** Reviewed PRs #355, #354, #353, #352. Baseline: 620 tests on main. **PR #355 (#312, cli-provider removal):** âœ… APPROVE â€” `cli-provider.ts` and `cli-provider.test.ts` fully deleted, `vi.mock('../cli-provider')` removed from 5 test files, replaced with inline `getConfiguration('editless.cli')` mocks. New `getLaunchCommand()` helper is a one-liner config read â€” tested implicitly through consumers. 573 tests pass. **PR #354 (#302, session state simplification):** âš ï¸ APPROVE with notes â€” `stateFromEvent` and events.jsonl tests properly deleted, terminal-manager tests updated to new 3-state model. However, `tree-providers.test.ts` has 4 stale mocks returning `'idle'` (lines 72, 451, 471, 663, 681) instead of `'inactive'` â€” semantically wrong but tests still pass since mocks return whatever you tell them. Should fix for correctness. 607 tests pass. **PR #353 (#306, plan detection removal):** âœ… APPROVE â€” `buildPlanFileIndex` function and type deleted, 22 plan-related tests removed (15 plan status + 7 buildPlanFileIndex), import cleaned up. Zero stale references. 596 tests pass. **PR #352 (#311, custom commands removal):** âœ… APPROVE â€” `agentCreationCommand` setting removed from package.json, handler code removed from extension.ts, docs updated. Zero stale references in tests or source. 619/620 tests pass (1 flaky session-context failure unrelated to PR â€” passes in isolation). Key pattern for removal PRs: when mock return values reference deleted enum/type values, vitest won't catch it because mocks bypass type checking â€” grep for old values in all `mockReturnValue` calls.
- **2026-02-20 â€” PR #424 config-refresh test review (#417):** âš ï¸ REQUEST CHANGES â€” 4 tests cover basic handler registration and invocation for ADO (org/project) and GitHub (repos) config changes, plus unrelated-key no-op. **Missing coverage:** (1) **Empty/invalid config values** â€” tests pass string to affectsConfiguration but never verify behavior when `config.get()` returns empty string, undefined, or array â†’ could `setAdoConfig(undefined, undefined)` or `setRepos([])` cause provider state corruption? (2) **Config change during active fetch** â€” `initAdoIntegration`/`initGitHubIntegration` are async and call `fetchAdoData()` / detect repos via gh CLI â€” if config changes mid-fetch, does second re-init race with first? (3) **Rapid successive config changes** â€” debounce/throttling not implemented, so 3 rapid changes trigger 3 `initAdoIntegration` calls â†’ could cause UI thrash or duplicate fetches. (4) **Auth state interaction** â€” if user changes `ado.organization` while `getAdoToken()` is prompting for auth, does the new config wait or use stale token? (5) **`findConfigHandlers` false positive risk** â€” handler test calls `affectsConfiguration(key)` with target key to check if handler matched, but a buggy handler that returns `true` for ALL keys would pass the "ignore unrelated keys" test since the helper only tests one key path. Should test cross-contamination explicitly. (6) **Test isolation** â€” all 4 tests share same `activate()` context from `beforeEach`, so handler array grows across tests â†’ could cause `forEach` in tests to fire handlers multiple times if not careful. **Mock boilerplate assessment:** Hoisted mocks clean, 170 lines of `vi.mock` setup is heavy but standard for VS Code extension testing. Test file path: `src/__tests__/config-refresh.test.ts`.

ğŸ“Œ **Team update (2026-02-16):** Default release target â€” All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. â€” decided by Casey Irvine

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ğŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).
- **2026-02-17 â€” Full coverage audit (UX focus):** 478 tests across 24 files, all passing. Key findings: (1) **ADO modules have zero tests** â€” `ado-auth.ts` and `ado-client.ts` have no test files at all; these back the ADO Work Items and PR views plus 3 command handlers. (2) **12 command handlers untested** â€” `filterWorkItems`, `clearWorkItemsFilter`, `setAdoPat`, `adoSignIn`, `openInBrowser`, `launchFromWorkItem`, `goToPR`, `goToSquadSettings`, `openInSquadUi`, `openRegistry`, `addSquad` have no execution tests. (3) **Terminal UX rendering untested** â€” tooltip generation, state-based icons, session context rendering, relative time formatting, and orphan display details in `editless-tree.ts` have zero coverage. (4) **Work items tree missing UX tests** â€” loading state, configuration prompts, ADO rendering, milestone group headers, click handlers, and tree view description updates all untested. (5) **Discovery UX dialogs untested** â€” `promptAndAddSquads()`, `registerDiscoveryCommand()`, `checkDiscoveryOnStartup()` (QuickPick/info message flows) have no tests. (6) **CLI provider update UX flow untested** â€” `checkProviderUpdatesOnStartup()` notification â†’ user click â†’ progress display path not tested. (7) **`detectSessionIds()` in TerminalManager has zero tests** despite being core reconciliation logic. (8) Testing patterns are strong: descriptive names, `vi.hoisted()` used correctly, `Map`-backed workspace state mocks, consistent fixture factories. Files needing most attention: `ado-auth.ts`, `ado-client.ts`, `editless-tree.ts` (terminal rendering), `work-items-tree.ts` (ADO + loading), `extension.ts` (12 untested commands), `discovery.ts` (UX dialogs), `terminal-manager.ts` (detectSessionIds), `scanner.ts` (internal parsers).

ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine

ğŸ“Œ **Team update (2026-02-16):** Use context keys for menu visibility based on dynamic state â€” Gate menu items on VS Code context keys when visibility depends on runtime state that can't be expressed through `viewItem` checks. For the "Upgrade All Squads" button, use `editless.squadUpgradeAvailable` context key set via `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()`. This pattern applies to all view-level actions depending on aggregate state (e.g., "any squad upgradeable"). â€” decided by Morty

ğŸ“Œ **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests â€” Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. â€” decided by Casey Irvine

ğŸ“Œ **Team update (2026-02-16):** Meeseeks writes regression tests for every bug Casey discovers â€” When Casey discovers a bug during usage, Meeseeks should write regression tests for that specific scenario BEFORE Morty fixes it. Tests-first approach for all user-discovered bugs ensures proper coverage and clear verification criteria when the fix lands. â€” decided by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ğŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ğŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ğŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ğŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).
- **2026-02-17 â€” addSquad command regression tests (#232), PR #237:** Added 11 regression tests for the `addSquad` command flow in `extension-commands.test.ts`. Extended the squad-upgrader mock to include `checkNpxAvailable`, `promptInstallNode`, and `isSquadInitialized`. Extended hoisted mocks to include `mockCreateTerminal` so terminal creation and command execution could be verified. Covered: npx availability check and early return, folder picker dialog with correct options, cancellation (undefined and empty array), squad init vs upgrade command selection based on `isSquadInitialized()`, terminal creation with correct name/cwd/command, success notifications (different messages for init vs upgrade), nested directory path handling, and full happy path flows for both init and upgrade scenarios. Total tests: 541 (up from 530).

ğŸ“Œ **Team update (2026-02-18):** v0.1.1 quality release scoped â€” 7 features to remove, 3-5 bugs to fix, extension.ts refactor planned. See decisions.md for full scope â€” decided by Rick + Casey



ğŸ“Œ **Team update (2026-02-20):** Session state model simplified to 3 states: active, inactive, orphaned. Old model (working/waiting-on-input/idle/stale) removed. Test changes reflect deterministic state transitions based on shell execution only. â€” decided by Morty


ğŸ“Œ Team update (2026-02-18): v0.2 quality gates established â€” decided by Rick

- **2026-02-20 â€” PR #359 test coverage review (#358):** Terminal session item display changed: label now uses `info.displayName` (stable) instead of session summary, description is just the relative creation time (`just now` / `Nm ago` / `Nh ago`), and `_buildTerminalDescription` (30-line method) was deleted. No existing tests were invalidated â€” prior tests didn't assert label/description content on terminal items. No dead tests for the deleted method (it was private, never directly tested). Added 7 new tests in `tree-providers.test.ts` under "terminal session item display": label uses `info.displayName`, custom label override via `labelManager` with ğŸ·ï¸ prefix, fallback to `displayName` when no custom label, "just now" for <1min sessions, "Nm ago" for minute-old sessions, "Nh ago" for hour-old sessions, and a negative assertion that description contains only the time string (no separators or state text). Total tests: 576 (up from 569).
- **2026-02-20 â€” acp-process-pool.test.ts, acp-handlers.test.ts, acp-process-pool-integration.test.ts (#370, M5e):** 79 new tests for ACP ProcessPool and updated handler delegation. **ProcessPool unit tests** (38): mock `child_process.spawn` with `EventEmitter`-based mock processes; test `create()` (unique IDs, cwd/env passthrough, default args), `getOutput()` (buffer accumulation, incremental reads clearing buffer, stdout+stderr combination, null exitCode while running), `waitForExit()` (exit code 0, non-zero, nullâ†’1 fallback, multiple callers on same promise, non-existent ID returns 1), `kill()` (platform-aware: execSync taskkill on Win32 / SIGKILL on Unix, no-throw on dead/unknown/undefined-pid), `release()` (cleanup removes from map, kills running process, release-after-kill, no-throw on unknown), `dispose()` (kills all running, no-throw on empty), edge cases (stderr capture, 100KB output no-truncate, rapid create/kill cycles, spawn errorâ†’code 1, multi-chunk accumulation, error-after-exit no-change). **Handler delegation tests** (35): mock ProcessPool as constructor with `vi.fn(function() { return mockPool })` â€” arrow functions fail as constructors in vitest 4.x. Updated stub tests to real delegation: `onWriteTextFile` (absolute/relative path, mkdir recursive, write errors, mkdir errors, empty content), terminal ops all delegate to `mockPool` methods with correct args, `exitCode: null` â†’ `undefined` conversion, `dispose()` delegates to pool. **Integration tests** (6): separate file with only vscode mock (no child_process mock); real `node` processes. Windows `shell: true` + cmd.exe mangles parentheses and single quotes â€” use `node --version` and `node -e "process.exit(42)"` (no parens/quotes needed) instead of `console.log()`. Incremental reads verified with `process.stdout.write` timing. Total tests: 707 (up from 628).
- **2026-02-20 â€” Phase 2 test quality review (#323, #324, #326):** Reviewed 18 new Phase 2 tests (13 terminal-manager + 7 session-context, though 2 tests overlap with pre-existing). Verdict: **REQUEST CHANGES** â€” 6 missing tests filed. **What's good:** crypto mock uses `importOriginal` correctly for ESM, all mock resolvers include `watchSession` + `watchSessionDir`, debounce/dispose tests in session-context use real fs.watch integration (generous 300ms waits avoid flakiness), focusTerminal string-ID lookup has 4 solid edge case tests, detectSessionIds preserves pre-set UUID from launchTerminal. **Gaps found:** (1) No test that `launchTerminal` calls `watchSession` when resolver is set â€” implementation lines 152-158 set up watcher, never asserted. (2) No test for watcher cleanup on terminal close â€” `onDidCloseTerminal` handler (lines 77-81) disposes watcher, never asserted. (3) No test for watcher wiring in `reconnectSession` (lines 278-284) or `relaunchSession` (lines 365-371). (4) No test for `dispose()` clearing all session watchers (lines 619-622). (5) No test for `launchTerminal` with custom `config.launchCommand` â€” the `--resume` append path (line 114) vs `buildCopilotCommand` path (line 119) are different branches but only the default is tested. (6) No test for malformed JSON in `watchSession`'s `readLastLine` (session-context line 189) â€” `JSON.parse` can throw on corrupt events.jsonl. (7) `watchSession` retry mechanism (1s retry loop when file doesn't exist, lines 218-224) is tested for "no crash" but not for actually retrying and connecting. (8) Double-dispose safety of watchers not tested. Mock resolver pattern is correct in all 4 locations.
- **2026-02-21 â€” v0.1.1 coverage audit:** Audited all 9 issues in the v0.1.1 PR (654 baseline tests). Found and filled 17 test gaps: **terminal-manager.ts** â€” launch timeout auto-clears at 10s boundary (vi.useFakeTimers, advance to 9999ms still launching, +1ms clears), resumable detection for undefined/empty-string agentSessionId (both non-resumable), MAX_REBOOT_COUNT=5 enforcement. **session-context.ts** â€” 10-day-old session is NOT stale under new 14-day threshold (boundary test for #328 constant bump). **editless-tree.ts** â€” orphan tree items differentiate resumable vs non-resumable (icon: 'history' vs 'circle-outline', description: 'resume' vs 'session ended', tooltip: 'pick up where you left off' vs 'cannot be resumed'). Required adding ThemeColor to vscode mock in tree-providers.test.ts. **prs-tree.ts** â€” author filter field: isFiltered, getFilterDescription, clearFilter resets, setFilter triggers fetchAll on author change. **work-items-tree.ts** â€” parent becomes leaf when children filtered out by type (getChildren returns empty). Key learning: when code adds new ThemeColor usage in tree items, the vscode mock in test files must be updated to include ThemeColor class. Total: 654 â†’ 671 tests.
- **2026-02-22 â€” Shared test mock extraction & icon assertion strengthening:** Created `src/__tests__/mocks/vscode-mocks.ts` to eliminate duplicate mock class definitions across test files. Extracted `TreeItem`, `TreeItemCollapsibleState`, `ThemeIcon`, `ThemeColor`, `MarkdownString`, `EventEmitter`, and `MockEditlessTreeItem` into shared module with `createVscodeMock()` factory. **Key learning:** When importing shared mocks into `vi.hoisted()` blocks, the import must be OUTSIDE the hoisted block (as a top-level import) â€” attempting to destructure from hoisted imports inside the block causes "Cannot access before initialization" errors. For async vi.mock factories (e.g., `vi.mock('vscode', async () => { ... })`), use `await import('./mocks/vscode-mocks')` to import shared classes. **Icon assertions:** Replaced weak `expect(iconPath).toBeDefined()` with specific `expect(iconPath).toEqual(new ThemeIcon('github'))` for placeholder config items in work-items-tree and prs-tree (GitHub uses `'github'`, ADO uses `'azure'`). Strengthening assertions catches regressions where the wrong icon is rendered (e.g., accidentally swapping GitHub/ADO icons). All 774 tests pass. Total tests: 774 (unchanged).


- **2026-02-26 â€” Auto-discover coverage review (editless-tree.ts, extension-commands.ts):** Added 9 new tests to cover gaps in `agent-settings` error handling, `editless.hideAgent` logic, and tree placeholder rendering. **agent-settings-extra.test.ts** (3): Verified `save()` failure propagation when `fs.mkdir` or `fs.writeFile` throws. Fixed mock behavior to align with implementation. **tree-providers-extra.test.ts** (2): Verified 'Hidden' items rendering (dimmed style, `squad-hidden` context) and correct placeholder behavior when all discovered items are hidden (no placeholder if hidden items are shown inline). **extension-commands-extra.test.ts** (4): Verified `editless.hideAgent` command toggles visibility correctly (calls `agentSettings.show` for hidden items, `agentSettings.hide` for visible ones) and refreshes tree. Addressed complex mocking requirements for `activate()` (vscode.workspace configuration, tree providers `setRepos`/`setAdoConfig`). Removed dead code: `promptAndAddSquads` in `discovery.ts` and its test `discovery-commands.test.ts` were already removed in this branch. Total tests: 783 (up from 774).
