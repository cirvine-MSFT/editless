name: Auto-merge squad state

on:
  pull_request:
    branches: [master]
    paths:
      - '.ai-team/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check only .ai-team files changed
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
          NON_SQUAD=$(echo "$FILES" | grep -v '^\\.ai-team/' || true)
          if [ -n "$NON_SQUAD" ]; then
            echo "Non-.ai-team files found: $NON_SQUAD"
            echo "squad_only=false" >> "$GITHUB_OUTPUT"
          else
            echo "Only .ai-team files changed"
            echo "squad_only=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto-approve
        if: steps.check.outputs.squad_only == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh pr review ${{ github.event.pull_request.number }} --approve

      - name: Enable auto-merge
        if: steps.check.outputs.squad_only == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh pr merge ${{ github.event.pull_request.number }} --squash --auto
