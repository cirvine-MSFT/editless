name: Squad Label Enforce

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enforce mutual exclusivity
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const appliedLabel = context.payload.label.name;

            // Namespaces with mutual exclusivity rules
            const EXCLUSIVE_PREFIXES = ['release:', 'type:', 'priority:', 'status:'];

            // Skip if not a managed namespace label
            if (!EXCLUSIVE_PREFIXES.some(p => appliedLabel.startsWith(p))) {
              core.info(`Label ${appliedLabel} is not in a managed namespace ‚Äî skipping`);
              return;
            }

            const allLabels = issue.labels.map(l => l.name);

            // Handle release: namespace (mutual exclusivity)
            if (appliedLabel.startsWith('release:')) {
              const otherReleaseLabels = allLabels.filter(l => 
                l.startsWith('release:') && l !== appliedLabel
              );

              if (otherReleaseLabels.length > 0) {
                // Remove conflicting release: labels
                for (const label of otherReleaseLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  core.info(`Removed conflicting label: ${label}`);
                }

                // Post update comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `üè∑Ô∏è Release target updated ‚Üí \`${appliedLabel}\``
                });
              }
            }

            // Handle type: namespace (mutual exclusivity)
            if (appliedLabel.startsWith('type:')) {
              const otherTypeLabels = allLabels.filter(l => 
                l.startsWith('type:') && l !== appliedLabel
              );

              if (otherTypeLabels.length > 0) {
                for (const label of otherTypeLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  core.info(`Removed conflicting label: ${label}`);
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `üè∑Ô∏è Issue type updated ‚Üí \`${appliedLabel}\``
                });
              }
            }

            // Handle priority: namespace (mutual exclusivity)
            if (appliedLabel.startsWith('priority:')) {
              const otherPriorityLabels = allLabels.filter(l => 
                l.startsWith('priority:') && l !== appliedLabel
              );

              if (otherPriorityLabels.length > 0) {
                for (const label of otherPriorityLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  core.info(`Removed conflicting label: ${label}`);
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `üè∑Ô∏è Priority updated ‚Üí \`${appliedLabel}\``
                });
              }
            }

            // Handle status: namespace (mutual exclusivity)
            if (appliedLabel.startsWith('status:')) {
              const otherStatusLabels = allLabels.filter(l => 
                l.startsWith('status:') && l !== appliedLabel
              );

              if (otherStatusLabels.length > 0) {
                for (const label of otherStatusLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: label
                  });
                  core.info(`Removed conflicting label: ${label}`);
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `üè∑Ô∏è Status updated ‚Üí \`${appliedLabel}\``
                });
              }
            }

            core.info(`Label enforcement complete for ${appliedLabel}`);
