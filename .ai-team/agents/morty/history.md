# Project Context

- **Owner:** Casey Irvine (cirvine@microsoft.com)
- **Project:** EditLess ‚Äî a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings

<!-- Append new learnings below. Each entry is something lasting about the project. -->

üìå **Team update (2026-02-15):** Command category pattern standardized ‚Äî all commands use `"category": "EditLess"` instead of title prefix to clean context menus while preserving command palette discoverability. This is now a team decision. ‚Äî decided by Casey Irvine

- **Command category pattern:** Use `"category": "EditLess"` on commands instead of prefixing titles with "EditLess: ". VS Code shows the category in the command palette but omits it in context menus ‚Äî clean context menus without losing discoverability.
- **F2 rename from terminal:** Clicking a tree terminal item intentionally focuses the terminal (`terminal.show()`). A second F2 keybinding with `"when": "terminalFocus"` covers the rename flow after focus moves. The `renameSession` handler falls back to `vscode.window.activeTerminal` when no arg is provided so the keybinding resolves the right terminal without a QuickPick.
- **Startup checks must be non-blocking:** `checkAgencyOnStartup` was using `execSync` which blocks the entire extension activation. Replaced with async `exec` callback. Any startup probe that shells out must use async execution to avoid freezing the activation path.
- **Cache user-facing prompts in globalState:** Toasts that fire on reload (like the agency update prompt) need dedup logic. Use `context.globalState` with a version+timestamp cache keyed by feature name. 24-hour cooldown prevents nagging while still re-checking after a reasonable interval or when the installed version changes.
- **User-facing text vs internal code:** When renaming user-facing strings (e.g. "squads" ‚Üí "agents"), only touch string literals shown to users ‚Äî status bar text, QuickPick placeholders, toast messages, and `package.json` view names. Leave internal variable names, function names, file names, and test fixture data unchanged. Squad-specific features (squad-upgrader) that reference the Squad CLI product keep "squad" in their messages.
- **Provider update infrastructure is generalized:** Update checking in `cli-provider.ts` is driven by optional `updateCommand`, `upToDatePattern`, and `updateRunCommand` fields on `CliProvider`. To add update support for a new CLI, just populate those fields in `KNOWN_PROFILES` ‚Äî no new functions needed. Cache keys are per-provider (`editless.${name}UpdatePrompt`). The old `checkAgencyOnStartup` still exists as a deprecated alias for `checkProviderUpdatesOnStartup`.
- **Terminal session persistence pattern:** `TerminalManager` persists terminal-to-squad mappings in `workspaceState` (key: `editless.terminalSessions`) and reconciles with live `vscode.window.terminals` on reload by matching `terminal.name`. The `TerminalInfo` interface stays unchanged ‚Äî a separate `PersistedTerminalInfo` serializes `Date` ‚Üí ISO string and adds `terminalName` for reconciliation. `_persist()` is called after every mutation (launch, close). `reconcile()` runs once after tree provider setup during activation.
- **Notification settings pattern:** Notifications use a master toggle (`notifications.enabled`) plus per-category booleans (`notifications.inbox`, `notifications.updates`). The shared `isNotificationEnabled(category)` helper in `notifications.ts` checks both ‚Äî master off kills all, otherwise defers to the category setting. New notification categories follow this same pattern: add a setting, pass the category key to the helper.
- **Agent discovery (#2 + #18):** Added `src/agent-discovery.ts` ‚Äî scans workspace `.github/agents/*.agent.md` and root-level `*.agent.md` files on activation, surfaces them in the tree view as read-only "Discovered Agents" section.
- **Add Agent / Add Squad buttons (#13):** Added `editless.addAgent` (creates `.github/agents/{name}.agent.md` template, re-runs discovery) and `editless.addSquad` (folder picker ‚Üí `git init` + `npx squad init` in a terminal) as header actions on the Agents pane.
- **Three-pane sidebar (#4):** Split sidebar into Agents, Work Items, and PRs collapsible views. Work Items and PRs are placeholder tree providers for future GitHub/ADO integration.
- **Launch from Work Item (#7):** Right-click context menu on work items shows a QuickPick of all registered agents/squads. Selecting one launches a terminal named after the issue, copies the issue URL to clipboard. Added optional `customName` parameter to `TerminalManager.launchTerminal`.
- **Plan Detection (#6):** Work item tree items now show plan status ‚Äî checks issue labels for "has plan", "has-plan", "plan", or "planned". Shows üìã for planned items and ‚ùì for items needing a plan, with description updated accordingly.
- **Work Item Type Filter (#17):** Added `editless.github.issueFilter` setting with `includeLabels` and `excludeLabels` arrays. Filtering is applied after fetching ‚Äî exclude hides matching issues, include restricts to matching issues, empty means show all.
- **Milestone Grouping (#10):** Issues with milestones are grouped under collapsible milestone headers in the Work Items tree. Issues without a milestone go under a collapsed "No Milestone" group. Falls back to flat list when no milestones exist.
- **Version Toasts (#51):** Update toasts now show both installed and available versions (e.g. "1.2.3 ‚Üí 1.3.0") when the available version can be parsed from the update command output. Falls back to current-only format when parsing fails.
- **Markdown Preview (#41):** Discovered agent `.md` files now open in VS Code's built-in markdown preview instead of the text editor. Added `editless.openFilePreview` command that delegates to `markdown.showPreview`.
- **PR Links (#33):** Added `editless.goToPR` context menu command on work items. Uses `gh pr list --search` to find PRs referencing the issue number. Single PR opens directly; multiple PRs show a QuickPick. Added `fetchLinkedPRs` to `github-client.ts`.
- **Settings schema polish (#88):** Added `markdownDescription`, `scope`, and `order` to all 11 settings. Added `enumDescriptions` and `enumItemLabels` to `cli.provider`. Order groups: Core (1‚Äì3), Notifications (10‚Äì12), CLI/Agent (20‚Äì22), GitHub (30‚Äì31). Scope: `resource` for workspace-specific paths/configs, `window` for user preferences. `discovery.scanPaths` was intentionally skipped (not in the plan's 11 settings).
- **Inline close button (#92):** Reused the existing `editless.closeTerminal` command ‚Äî added `"icon": "$(close)"` and an `inline@99` menu entry. No new command or handler needed. When an existing command already does what you need, just wire it into the UI layer (icon + menu placement).
- **Async CLI probing + custom provider (#107, #109):** Replaced `execSync` with async `exec` in `probeCliVersion()` to eliminate 15s activation freeze. `probeAllProviders()` is now async, called fire-and-forget from `activate()` with `resolveActiveProvider()` chained via `.then()`. Added `custom` profile to `KNOWN_PROFILES` with empty command/versionCommand for presence-only detection. `resolveActiveProvider()` now honors explicit `custom` setting without requiring a probe. Updated all tests for async flow. PR #121.
- **P1 code quality fixes (#114, #116, #117, #119):** Four mechanical fixes batched into one PR. (1) Added `getLastActivityAt()` public getter to `TerminalManager` to replace bracket-notation private field access in `editless-tree.ts`. (2) Stored the leaked `labelManager.onDidChange()` subscription, added `dispose()` to `EditlessTreeProvider` implementing `vscode.Disposable`, pushed provider to `context.subscriptions`. (3) Removed 4 dead prototype types from `types.ts` (`TerminalSession`, `DashboardState`, `WebSocketMessage`, `LaunchRequest`) ‚Äî zero imports anywhere. (4) Removed unused `promptRenameSession` export from `session-labels.ts`. All 200 tests pass, tsc clean. PR #124.
- **Remove custom commands feature (#131):** Removed `editless.customCommands` setting, `editless.runCustomCommand` command + handler, context menu entry, `CustomCommandEntry` interface, and `custom-commands.test.ts`. Updated `custom` CLI provider enum description to not reference the removed feature. Updated `docs/SETTINGS.md`. The `editless.agentCreationCommand` setting (separate feature) was intentionally preserved ‚Äî its local variable `customCommand` is unrelated naming. 340 tests pass, tsc clean. PR #134.
- **Deep-link configure buttons (#102):** Work Items and PRs tree views now show two configure links when no repos are set: "Configure in GitHub" (opens settings filtered to `editless.github`) and "Configure in ADO" (opens settings filtered to `editless.ado`). Added `editless.ado.organization` and `editless.ado.project` settings as foundation for future ADO integration. Registered `editless.configureAdo` command. Widened GitHub filter from `editless.github.repos` to `editless.github` to show all GitHub settings. 349 tests pass, tsc clean. PR #138.
- **Session status: working vs waiting-on-input (#133):** Split the generic `active` SessionState into `working` (shell execution in progress) and `waiting-on-input` (execution finished, user needs to respond). `getStateIcon` maps working‚Üí`loading~spin`, waiting-on-input‚Üí`bell-dot`. Detection: `shellExecutionActive=true` ‚Üí working; recent activity but no execution ‚Üí waiting-on-input; beyond idle threshold ‚Üí idle/stale as before. `needs-attention` does NOT override `working` (per team decision). `editless-tree.ts` needed no changes ‚Äî it delegates to helper functions. 348 tests pass, tsc clean. PR #137.
- **PR merge conflict indicator (#129):** Added `mergeable` field to `GitHubPR` interface and `fetchMyPRs`/`fetchLinkedPRs` queries. PRs with `mergeable === 'CONFLICTING'` show a `warning` ThemeIcon (with `list.warningForeground` color), `‚ö†Ô∏è has conflicts` in the description, and a conflict warning in the tooltip. UNKNOWN/empty states are handled gracefully (no indicator). 6 new tests, 354 total pass, tsc clean. PR #136.
- **Background terminal on squad add (#127):** Added `hideFromUser: true` to `createTerminal` options in `editless.addSquad` command and removed `terminal.show()`. Only the squad init/upgrade terminal is hidden ‚Äî `launchTerminal` in `terminal-manager.ts` and `addAgent` custom-command terminal remain user-visible since they're explicitly user-initiated. 348 tests pass, tsc clean. PR #135.
- **Terminal layout restore (#40):** Added `TerminalLayoutManager` in `src/terminal-layout.ts` ‚Äî listens to `onDidChangeVisibleTextEditors` and fires `workbench.action.toggleMaximizedPanel` when all editors close after being opened from a no-editor state. Tracks `hadVisibleEditors` and `panelWasMaximized` to avoid false triggers. Added `editless.restoreTerminalLayout` boolean setting (default: true, order: 4, scope: window). Setting is read live on each event so it can be toggled mid-session. 7 new tests, 354 total pass, tsc clean. PR #142.
- **Persistent upgrade indicator (#91):** Squad items now show `upgrade available` in their description when the local Squad CLI version is older than the latest on GitHub. Added `getLatestSquadVersion()` (HTTPS fetch from `raw.githubusercontent.com`, cached 1hr), `isNewerVersion()` semver comparison, and `checkSquadUpgradesOnStartup()` in `squad-upgrader.ts`. Tree provider stores upgrade state in `_upgradeAvailable` map; sets `contextValue` to `squad-upgradeable` for upgradeable squads. Inline upgrade button now only shows for squads with available upgrades (`viewItem == squad-upgradeable`); other squad menus use regex match (`viewItem =~ /^squad/`). Indicator clears after upgrade completes via `onUpgradeComplete` callback. 7 new tests (isNewerVersion + tree indicator), 358 total pass, tsc clean. PR #145.
- **Tree UX: click to expand, + button for new session (#144):** Removed `command` property from squad tree items so clicking expands/collapses (standard VS Code tree behavior) instead of launching a terminal. Added `$(add)` inline button on squad and agent nodes via `view/item/context` menu contribution with `viewItem =~ /^squad|^agent$/`. Updated `editless.launchSession` handler to accept both `string` (squadId) and `EditlessTreeItem` arguments. Agent items now carry `squadId` so the inline button resolves the correct squad. 368 tests pass, tsc clean. PR #147.
