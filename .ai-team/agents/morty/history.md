# Project Context

- **Owner:** Casey Irvine (cirvine@microsoft.com)
- **Project:** EditLess ‚Äî a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings


üìå **Team update (2026-02-16):** Documentation animation strategy ‚Äî EditLess uses optimized GIFs stored in docs/media/ directory. Primary tool: ScreenToGif (Windows). Files must be <1 MB, max 800px width, 3‚Äì8 seconds duration. File naming is descriptive kebab-case (e.g., planning-feature.gif). Re-recording triggers documented: UI structure changes, command/shortcut changes, label changes, layout changes. Team reviews animations on code review checklist. ‚Äî decided by Summer

üìå **Team update (2026-02-16):** Default release target ‚Äî All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. ‚Äî decided by Casey Irvine

üìå **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint ‚Äî Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. ‚Äî reinforced by Casey Irvine

üìå **Team update (2026-02-16):** Use context keys for menu visibility based on dynamic state ‚Äî Gate menu items on VS Code context keys when visibility depends on runtime state that can't be expressed through `viewItem` checks. For the "Upgrade All Squads" button, use `editless.squadUpgradeAvailable` context key set via `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()`. This pattern applies to all view-level actions depending on aggregate state (e.g., "any squad upgradeable"). ‚Äî decided by Morty

üìå **Team update (2026-02-16):** Meeseeks writes regression tests for every bug Casey discovers ‚Äî When Casey discovers a bug during usage, Meeseeks should write regression tests for that specific scenario BEFORE Morty fixes it. Tests-first approach for all user-discovered bugs ensures proper coverage and clear verification criteria when the fix lands. ‚Äî decided by Casey Irvine

- **F2 keybinding with terminalFocus doesn't work (#229):** VS Code's terminal captures raw F2 keycode before the extension keybinding system processes it, causing "q" to be sent to terminal instead of triggering rename. When terminal is focused, key events are consumed by terminal first. Terminal-scoped keybindings are unreliable for extension commands ‚Äî use context menus, command palette, or tree view keybindings instead. Removed `"when": "terminalFocus"` F2 binding. Tree view F2 bindings still work because editlessTree gets focus priority.
üìå **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests ‚Äî Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. ‚Äî decided by Casey Irvine
üìå **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint ‚Äî Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. ‚Äî reinforced by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

üìå **Team update (2026-02-15):** Command category pattern standardized ‚Äî all commands use `"category": "EditLess"` instead of title prefix to clean context menus while preserving command palette discoverability. This is now a team decision. ‚Äî decided by Casey Irvine

- **Command category pattern:** Use `"category": "EditLess"` on commands instead of prefixing titles with "EditLess: ". VS Code shows the category in the command palette but omits it in context menus ‚Äî clean context menus without losing discoverability.
- **F2 rename from terminal:** Clicking a tree terminal item intentionally focuses the terminal (`terminal.show()`). A second F2 keybinding with `"when": "terminalFocus"` covers the rename flow after focus moves. The `renameSession` handler falls back to `vscode.window.activeTerminal` when no arg is provided so the keybinding resolves the right terminal without a QuickPick.
- **Startup checks must be non-blocking:** `checkAgencyOnStartup` was using `execSync` which blocks the entire extension activation. Replaced with async `exec` callback. Any startup probe that shells out must use async execution to avoid freezing the activation path.
- **Cache user-facing prompts in globalState:** Toasts that fire on reload (like the agency update prompt) need dedup logic. Use `context.globalState` with a version+timestamp cache keyed by feature name. 24-hour cooldown prevents nagging while still re-checking after a reasonable interval or when the installed version changes.
- **User-facing text vs internal code:** When renaming user-facing strings (e.g. "squads" ‚Üí "agents"), only touch string literals shown to users ‚Äî status bar text, QuickPick placeholders, toast messages, and `package.json` view names. Leave internal variable names, function names, file names, and test fixture data unchanged. Squad-specific features (squad-upgrader) that reference the Squad CLI product keep "squad" in their messages.
- **Provider update infrastructure is generalized:** Update checking in `cli-provider.ts` is driven by optional `updateCommand`, `upToDatePattern`, and `updateRunCommand` fields on `CliProvider`. To add update support for a new CLI, just populate those fields in `KNOWN_PROFILES` ‚Äî no new functions needed. Cache keys are per-provider (`editless.${name}UpdatePrompt`). The old `checkAgencyOnStartup` still exists as a deprecated alias for `checkProviderUpdatesOnStartup`.
- **Terminal session persistence pattern:** `TerminalManager` persists terminal-to-squad mappings in `workspaceState` (key: `editless.terminalSessions`) and reconciles with live `vscode.window.terminals` on reload by matching `terminal.name`. The `TerminalInfo` interface stays unchanged ‚Äî a separate `PersistedTerminalInfo` serializes `Date` ‚Üí ISO string and adds `terminalName` for reconciliation. `_persist()` is called after every mutation (launch, close). `reconcile()` runs once after tree provider setup during activation.
- **Notification settings pattern:** Notifications use a master toggle (`notifications.enabled`) plus per-category booleans (`notifications.inbox`, `notifications.updates`). The shared `isNotificationEnabled(category)` helper in `notifications.ts` checks both ‚Äî master off kills all, otherwise defers to the category setting. New notification categories follow this same pattern: add a setting, pass the category key to the helper.
- **Agent discovery (#2 + #18):** Added `src/agent-discovery.ts` ‚Äî scans workspace `.github/agents/*.agent.md` and root-level `*.agent.md` files on activation, surfaces them in the tree view as read-only "Discovered Agents" section.
- **Add Agent / Add Squad buttons (#13):** Added `editless.addAgent` (creates `.github/agents/{name}.agent.md` template, re-runs discovery) and `editless.addSquad` (folder picker ‚Üí `git init` + `npx squad init` in a terminal) as header actions on the Agents pane.
- **Three-pane sidebar (#4):** Split sidebar into Agents, Work Items, and PRs collapsible views. Work Items and PRs are placeholder tree providers for future GitHub/ADO integration.
- **Launch from Work Item (#7):** Right-click context menu on work items shows a QuickPick of all registered agents/squads. Selecting one launches a terminal named after the issue, copies the issue URL to clipboard. Added optional `customName` parameter to `TerminalManager.launchTerminal`.
- **Plan Detection (#6):** Work item tree items now show plan status ‚Äî checks issue labels for "has plan", "has-plan", "plan", or "planned". Shows üìã for planned items and ‚ùì for items needing a plan, with description updated accordingly.
- **Work Item Type Filter (#17):** Added `editless.github.issueFilter` setting with `includeLabels` and `excludeLabels` arrays. Filtering is applied after fetching ‚Äî exclude hides matching issues, include restricts to matching issues, empty means show all.
- **Milestone Grouping (#10):** Issues with milestones are grouped under collapsible milestone headers in the Work Items tree. Issues without a milestone go under a collapsed "No Milestone" group. Falls back to flat list when no milestones exist.
- **Version Toasts (#51):** Update toasts now show both installed and available versions (e.g. "1.2.3 ‚Üí 1.3.0") when the available version can be parsed from the update command output. Falls back to current-only format when parsing fails.
- **Markdown Preview (#41):** Discovered agent `.md` files now open in VS Code's built-in markdown preview instead of the text editor. Added `editless.openFilePreview` command that delegates to `markdown.showPreview`.
- **PR Links (#33):** Added `editless.goToPR` context menu command on work items. Uses `gh pr list --search` to find PRs referencing the issue number. Single PR opens directly; multiple PRs show a QuickPick. Added `fetchLinkedPRs` to `github-client.ts`.
- **Settings schema polish (#88):** Added `markdownDescription`, `scope`, and `order` to all 11 settings. Added `enumDescriptions` and `enumItemLabels` to `cli.provider`. Order groups: Core (1‚Äì3), Notifications (10‚Äì12), CLI/Agent (20‚Äì22), GitHub (30‚Äì31). Scope: `resource` for workspace-specific paths/configs, `window` for user preferences. `discovery.scanPaths` was intentionally skipped (not in the plan's 11 settings).
- **Inline close button (#92):** Reused the existing `editless.closeTerminal` command ‚Äî added `"icon": "$(close)"` and an `inline@99` menu entry. No new command or handler needed. When an existing command already does what you need, just wire it into the UI layer (icon + menu placement).
- **Async CLI probing + custom provider (#107, #109):** Replaced `execSync` with async `exec` in `probeCliVersion()` to eliminate 15s activation freeze. `probeAllProviders()` is now async, called fire-and-forget from `activate()` with `resolveActiveProvider()` chained via `.then()`. Added `custom` profile to `KNOWN_PROFILES` with empty command/versionCommand for presence-only detection. `resolveActiveProvider()` now honors explicit `custom` setting without requiring a probe. Updated all tests for async flow. PR #121.
- **P1 code quality fixes (#114, #116, #117, #119):** Four mechanical fixes batched into one PR. (1) Added `getLastActivityAt()` public getter to `TerminalManager` to replace bracket-notation private field access in `editless-tree.ts`. (2) Stored the leaked `labelManager.onDidChange()` subscription, added `dispose()` to `EditlessTreeProvider` implementing `vscode.Disposable`, pushed provider to `context.subscriptions`. (3) Removed 4 dead prototype types from `types.ts` (`TerminalSession`, `DashboardState`, `WebSocketMessage`, `LaunchRequest`) ‚Äî zero imports anywhere. (4) Removed unused `promptRenameSession` export from `session-labels.ts`. All 200 tests pass, tsc clean. PR #124.
- **Remove custom commands feature (#131):** Removed `editless.customCommands` setting, `editless.runCustomCommand` command + handler, context menu entry, `CustomCommandEntry` interface, and `custom-commands.test.ts`. Updated `custom` CLI provider enum description to not reference the removed feature. Updated `docs/SETTINGS.md`. The `editless.agentCreationCommand` setting (separate feature) was intentionally preserved ‚Äî its local variable `customCommand` is unrelated naming. 340 tests pass, tsc clean. PR #134.
- **Deep-link configure buttons (#102):** Work Items and PRs tree views now show two configure links when no repos are set: "Configure in GitHub" (opens settings filtered to `editless.github`) and "Configure in ADO" (opens settings filtered to `editless.ado`). Added `editless.ado.organization` and `editless.ado.project` settings as foundation for future ADO integration. Registered `editless.configureAdo` command. Widened GitHub filter from `editless.github.repos` to `editless.github` to show all GitHub settings. 349 tests pass, tsc clean. PR #138.
- **Session status: working vs waiting-on-input (#133):** Split the generic `active` SessionState into `working` (shell execution in progress) and `waiting-on-input` (execution finished, user needs to respond). `getStateIcon` maps working‚Üí`loading~spin`, waiting-on-input‚Üí`bell-dot`. Detection: `shellExecutionActive=true` ‚Üí working; recent activity but no execution ‚Üí waiting-on-input; beyond idle threshold ‚Üí idle/stale as before. `needs-attention` does NOT override `working` (per team decision). `editless-tree.ts` needed no changes ‚Äî it delegates to helper functions. 348 tests pass, tsc clean. PR #137.
- **PR merge conflict indicator (#129):** Added `mergeable` field to `GitHubPR` interface and `fetchMyPRs`/`fetchLinkedPRs` queries. PRs with `mergeable === 'CONFLICTING'` show a `warning` ThemeIcon (with `list.warningForeground` color), `‚ö†Ô∏è has conflicts` in the description, and a conflict warning in the tooltip. UNKNOWN/empty states are handled gracefully (no indicator). 6 new tests, 354 total pass, tsc clean. PR #136.
- **Background terminal on squad add (#127):** Added `hideFromUser: true` to `createTerminal` options in `editless.addSquad` command and removed `terminal.show()`. Only the squad init/upgrade terminal is hidden ‚Äî `launchTerminal` in `terminal-manager.ts` and `addAgent` custom-command terminal remain user-visible since they're explicitly user-initiated. 348 tests pass, tsc clean. PR #135.
- **Terminal layout restore (#40):** Added `TerminalLayoutManager` in `src/terminal-layout.ts` ‚Äî listens to `onDidChangeVisibleTextEditors` and fires `workbench.action.toggleMaximizedPanel` when all editors close after being opened from a no-editor state. Tracks `hadVisibleEditors` and `panelWasMaximized` to avoid false triggers. Added `editless.restoreTerminalLayout` boolean setting (default: true, order: 4, scope: window). Setting is read live on each event so it can be toggled mid-session. 7 new tests, 354 total pass, tsc clean. PR #142.
- **Persistent upgrade indicator (#91):** Squad items now show `upgrade available` in their description when the local Squad CLI version is older than the latest on GitHub. Added `getLatestSquadVersion()` (HTTPS fetch from `raw.githubusercontent.com`, cached 1hr), `isNewerVersion()` semver comparison, and `checkSquadUpgradesOnStartup()` in `squad-upgrader.ts`. Tree provider stores upgrade state in `_upgradeAvailable` map; sets `contextValue` to `squad-upgradeable` for upgradeable squads. Inline upgrade button now only shows for squads with available upgrades (`viewItem == squad-upgradeable`); other squad menus use regex match (`viewItem =~ /^squad/`). Indicator clears after upgrade completes via `onUpgradeComplete` callback. 7 new tests (isNewerVersion + tree indicator), 358 total pass, tsc clean. PR #145.
- **Tree UX: click to expand, + button for new session (#144):** Removed `command` property from squad tree items so clicking expands/collapses (standard VS Code tree behavior) instead of launching a terminal. Added `$(add)` inline button on squad and agent nodes via `view/item/context` menu contribution with `viewItem =~ /^squad|^agent$/`. Updated `editless.launchSession` handler to accept both `string` (squadId) and `EditlessTreeItem` arguments. Agent items now carry `squadId` so the inline button resolves the correct squad. 368 tests pass, tsc clean. PR #147.
- **Work items plan icon fix (#139):** `buildIssueItem()` in `src/work-items-tree.ts` had a binary planned/not-planned check that didn't recognize `status:planned` or `status:needs-plan` GitHub labels. Replaced with ternary logic: planned (üìã, matches `status:planned` + legacy labels), needs-plan (‚ùì, matches `status:needs-plan`), and neutral (‚Äî, no plan label). Tooltip and description update accordingly. Created `src/__tests__/work-items-tree.test.ts` with 15 tests covering all label variants, case-insensitivity, and precedence when both labels present. 383 tests pass, tsc clean.
- **Squad folder rename backward compat (#93):** Created `src/team-dir.ts` with `resolveTeamDir()`, `resolveTeamMd()`, and `TEAM_DIR_NAMES` constant. The utility checks `.squad/` first (new Squad CLI convention), then `.ai-team/` (legacy fallback). Updated `discovery.ts`, `scanner.ts`, `squad-upgrader.ts`, and `watcher.ts` to use the utility instead of hardcoded `.ai-team` paths. Error messages now say `.squad/ (or .ai-team/)`. Created `src/__tests__/team-dir.test.ts` (12 tests). Added `.squad/` tests to discovery and scanner test suites. 409 tests pass, tsc clean.
- **Session persistence for crash recovery (#94):** Added `agentSessionId` and `launchCommand` optional fields to both `TerminalInfo` and `PersistedTerminalInfo`. `launchCommand` is captured from `AgentTeamConfig` during `launchTerminal()` and persisted to `workspaceState`. `relaunchSession()` now sends the persisted `launchCommand` (or `launchCommand --resume <agentSessionId>` when a session ID exists) instead of creating a silent terminal. Added `setAgentSessionId()` public method for external session ID association. All new fields flow through reconcile, reconnect, and persist paths. The `deactivate()` handler already called `persist()` ‚Äî no change needed there. 14 new tests, 409 total pass, tsc clean.

üìå **Team update (2026-02-16):** v0.1 Release Triage & Scope Lock ‚Äî #148 (session labels off by one) triaged as P0 and assigned to you. 7 P0 items locked for v0.1, 8 P1 items prioritized, 5 items cut to post-v0.1. Scope lock: no new v0.1 items after 15:00 UTC. ‚Äî decided by Rick

üìå **Team update (2026-02-16):** Session State Design Issue ‚Äî `waiting-on-input` misclassification documented as a P2 design issue in decisions.md. Investigation revealed that the heuristic conflates "recent activity" with "waiting for user input" and has no positive signal to distinguish legitimate input-waiting scenarios. Fix requires inverting the default to `idle` and introducing a separate `_waitingOnInput` signal or terminal output parsing. Filed as issue #226. ‚Äî investigated by Morty
- **Session state `waiting-on-input` misclassification (investigation):** `getSessionState()` in `terminal-manager.ts:336-365` defaults to `waiting-on-input` for any terminal with `_lastActivityAt` within the 5-minute idle threshold and no active shell execution. This means every terminal shows `waiting-on-input` for up to 5 minutes after any command finishes ‚Äî even when idle. Root cause is a design issue: `onDidEndTerminalShellExecution` (line 86-89) sets both `_shellExecutionActive=false` and `_lastActivityAt=Date.now()`, but there is no positive signal distinguishing "agent asking a question" from "command finished normally." The reconcile path (line 449) restoring `_lastActivityAt` from `persisted.lastSeenAt` amplifies this on reload. Fix requires inverting the default to `idle` and introducing a separate positive signal for `waiting-on-input`.
- **Filter category grouping (#213):** The work items filter now groups active filters by their label prefix (everything before the colon). Within each prefix group (e.g., `release:`), filters use OR logic. Across different prefix groups (e.g., `type:` + `release:`), filters use AND logic. This lets you say "show me docs OR bugs from v0.1 OR backlog" by selecting `type:docs`, `type:bug`, `release:v0.1`, `release:backlog`. The pattern is implemented in a private `matchesLabelFilter()` helper that groups by prefix, checks OR within each group, and AND across groups.
- **Upgrade All button context key (#228):** The "Upgrade All Squads" button now uses a context key `editless.squadUpgradeAvailable` to gate visibility instead of always showing when the Agents view is active. VS Code's TreeView API doesn't support dynamic menu visibility based on tree contents, so we use `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()` to track whether any squad has an upgrade available. The `onUpgradeComplete` callback re-runs the check to update the context key. The per-squad inline button already used `viewItem == squad-upgradeable`, now both buttons are gated consistently.

- **Add Squad silent failure (#232):** The `addSquad` handler created a hidden terminal (`hideFromUser: true`, added in #127) to run `npx squad init` but never registered the resulting squad. Two issues: (1) `sendText` didn't include `exit`, so the hidden terminal stayed open forever; (2) nothing listened for terminal completion to trigger registration. Fix: append `; exit` to the command, register an `onDidCloseTerminal` listener that discovers and registers the squad via `discoverAgentTeams()` on the parent directory when the terminal closes. The listener filters by terminal identity and auto-disposes. Key pattern: when using hidden terminals for background work, always ensure the shell exits and wire up a completion listener ‚Äî `sendText` alone is fire-and-forget.

