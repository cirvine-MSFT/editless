# Project Context

- **Owner:** Casey Irvine (cirvine@microsoft.com)
- **Project:** EditLess â€” a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings


ðŸ“Œ **Team update (2026-02-16):** Documentation animation strategy â€” EditLess uses optimized GIFs stored in docs/media/ directory. Primary tool: ScreenToGif (Windows). Files must be <1 MB, max 800px width, 3â€“8 seconds duration. File naming is descriptive kebab-case (e.g., planning-feature.gif). Re-recording triggers documented: UI structure changes, command/shortcut changes, label changes, layout changes. Team reviews animations on code review checklist. â€” decided by Summer

ðŸ“Œ **Team update (2026-02-16):** Default release target â€” All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. â€” decided by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ðŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ðŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ðŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).


<!-- Append new learnings below. Each entry is something lasting about the project. -->

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ðŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ðŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ðŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).
- **2026-02-17 â€” Full coverage audit (UX focus):** 478 tests across 24 files, all passing. Key findings: (1) **ADO modules have zero tests** â€” `ado-auth.ts` and `ado-client.ts` have no test files at all; these back the ADO Work Items and PR views plus 3 command handlers. (2) **12 command handlers untested** â€” `filterWorkItems`, `clearWorkItemsFilter`, `setAdoPat`, `adoSignIn`, `openInBrowser`, `launchFromWorkItem`, `goToPR`, `goToSquadSettings`, `openInSquadUi`, `openRegistry`, `addSquad` have no execution tests. (3) **Terminal UX rendering untested** â€” tooltip generation, state-based icons, session context rendering, relative time formatting, and orphan display details in `editless-tree.ts` have zero coverage. (4) **Work items tree missing UX tests** â€” loading state, configuration prompts, ADO rendering, milestone group headers, click handlers, and tree view description updates all untested. (5) **Discovery UX dialogs untested** â€” `promptAndAddSquads()`, `registerDiscoveryCommand()`, `checkDiscoveryOnStartup()` (QuickPick/info message flows) have no tests. (6) **CLI provider update UX flow untested** â€” `checkProviderUpdatesOnStartup()` notification â†’ user click â†’ progress display path not tested. (7) **`detectSessionIds()` in TerminalManager has zero tests** despite being core reconciliation logic. (8) Testing patterns are strong: descriptive names, `vi.hoisted()` used correctly, `Map`-backed workspace state mocks, consistent fixture factories. Files needing most attention: `ado-auth.ts`, `ado-client.ts`, `editless-tree.ts` (terminal rendering), `work-items-tree.ts` (ADO + loading), `extension.ts` (12 untested commands), `discovery.ts` (UX dialogs), `terminal-manager.ts` (detectSessionIds), `scanner.ts` (internal parsers).

ðŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Use context keys for menu visibility based on dynamic state â€” Gate menu items on VS Code context keys when visibility depends on runtime state that can't be expressed through `viewItem` checks. For the "Upgrade All Squads" button, use `editless.squadUpgradeAvailable` context key set via `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()`. This pattern applies to all view-level actions depending on aggregate state (e.g., "any squad upgradeable"). â€” decided by Morty

ðŸ“Œ **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests â€” Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. â€” decided by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Meeseeks writes regression tests for every bug Casey discovers â€” When Casey discovers a bug during usage, Meeseeks should write regression tests for that specific scenario BEFORE Morty fixes it. Tests-first approach for all user-discovered bugs ensures proper coverage and clear verification criteria when the fix lands. â€” decided by Casey Irvine
<!-- Append new learnings below. Each entry is something lasting about the project. -->

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

ðŸ“Œ Team update (2026-02-16): Label taxonomy simplified â€” `go:` namespace (go:yes, go:no, go:needs-research) removed. Triage now applies `status:needs-plan` only when no existing `status:` label exists. Release labels limited to `release:v0.1` and `release:backlog`. When testing label workflows, focus on these retained labels and test that triage respects pre-existing status labels. â€” decided by Birdperson

ðŸ“Œ Team update (2026-02-16): Casey's voice in personal narratives â€” Conversational, enthusiastic, and authentic. Use short declarative sentences for impact and preserve casual phrasing. Edits should be light-touchâ€”fixing grammar without changing the natural, personal tone. â€” decided by Summer

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty
ðŸ“Œ Team update (2026-02-16): Session persistence â€” `launchCommand` now persisted in `PersistedTerminalInfo` rather than looked up from config at relaunch. When `agentSessionId` is set, relaunch appends `--resume <sessionId>` to the persisted command (team convention for resume flag). â€” decided by Morty

- **2026-02-16 â€” cli-provider.test.ts (#11):**`checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 â€” cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` â€” it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` â€” use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 â€” terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence â€” inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 â€” notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories â€” vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` â€” test the 0â†’N transition, the Nâ†’N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 â€” visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient â€” no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 â€” tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` â€” mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 â€” Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host â€” add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 â€” P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 â€” all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array â€” stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
- **2026-02-17 â€” extension-commands.test.ts (#108):** 57 tests for command handlers in `extension.ts` `activate()`. Key technique: mock `vscode.commands.registerCommand` to capture handler closures into a `Map<string, Function>`, then call handlers directly. Define a `MockEditlessTreeItem` class in `vi.hoisted()` and export it as `EditlessTreeItem` from the editless-tree mock â€” this makes `instanceof` checks in `resolveTerminal()` work correctly. All constructor mocks (TerminalManager, SessionLabelManager, etc.) must use `vi.fn(function() { return {...} })` not arrow functions â€” vitest 4.x rejects arrow functions as constructors with `new`. Covered: `launchSession` (empty registry, direct/picker launch), `renameSession` (tree item, active terminal, QuickPick fallback, cancel/empty), `focusTerminal`/`closeTerminal` (terminal resolution), `hideAgent`/`showHiddenAgents`/`showAllAgents` (visibility toggle), `relaunchSession`/`dismissOrphan` (orphan handling), `renameSquad`/`changeModel` (registry updates with edge cases), and delegation commands. Total tests: 257 (up from 200).
- **2026-02-17 â€” Agency CLI surface area audit (#90), PR #141:** Guardrail test that scans all non-test `.ts` source files for `agency` references (case-insensitive) and asserts each line matches an approved pattern. Allowlist covers: CLI commands (`agency --version`, `agency update`, `agency copilot`), string literals (`'agency'`/`"agency"`), capitalized display text (`Agency`), camelCase identifiers (`agencyProvider`, etc.), and comment lines. Uses `fs.readdirSync` to recursively collect source files, skipping `__tests__/` and `__integration__/`. Three test cases: main audit, sanity check that files exist, sanity check that known references are found. Total tests: 353 (up from 350).
- **2026-02-17 â€” P1 test coverage batch (#111, #113, #115, #118, #120), PR #128:** 51 new tests across 5 files. **squad-upgrader.test.ts** (10): mock `promisify(exec)` via `util` mock to control `execAsync`; mock `fs.existsSync`/`readFileSync` for file checks; tested `checkNpxAvailable` (success/error), `isSquadInitialized` (.ai-team path check), `getLocalSquadVersion` (valid frontmatter, missing file, no frontmatter, no version field, read error, whitespace trimming). **status-bar.test.ts** (7): mock `vscode.window.createStatusBarItem` to return object with mutable `text`; mock `scanSquad` for inbox counts; tested `update()` (scans all squads, renders counts, inbox badge conditional), `updateSessionsOnly()` (uses cached inbox, skips scanner), `dispose()` including double-dispose tolerance. **watcher.test.ts** (7): mock `createFileSystemWatcher` returning objects with event handlers; use `vi.useFakeTimers()` for debounce testing; tested constructor (watcher-per-squad, empty array), `updateSquads()` (disposes old, creates new), debounce (5 rapid events â†’ 1 notification, custom debounce ms), `dispose()` (clears watchers + timers). **prs-tree.test.ts** (11): new file separate from tree-providers.test.ts; tested all 6 `derivePRState` cases (draft, merged, closed, approved, changes-requested, open/empty reviewDecision), multi-repo grouping (repo headers with contextValue `repo-group`) vs flat list (single repo), loading state, empty state, config placeholder. **github-client.test.ts** (16): mock `promisify(execFile)` via `util` mock; tested `isGhAvailable` (true/false), `fetchAssignedIssues` (valid parse, empty array, null milestone, malformed JSON, error), `fetchMyPRs` (valid parse, empty, null reviewDecision defaults to `''`, malformed JSON, error), `fetchLinkedPRs` (search by issue number, null reviewDecision, error). Total tests: 308 (up from 257).
- **2026-02-17 â€” addSquad command regression tests (#232), PR #237:** Added 11 regression tests for the `addSquad` command flow in `extension-commands.test.ts`. Extended the squad-upgrader mock to include `checkNpxAvailable`, `promptInstallNode`, and `isSquadInitialized`. Extended hoisted mocks to include `mockCreateTerminal` so terminal creation and command execution could be verified. Covered: npx availability check and early return, folder picker dialog with correct options, cancellation (undefined and empty array), squad init vs upgrade command selection based on `isSquadInitialized()`, terminal creation with correct name/cwd/command, success notifications (different messages for init vs upgrade), nested directory path handling, and full happy path flows for both init and upgrade scenarios. Total tests: 541 (up from 530).


