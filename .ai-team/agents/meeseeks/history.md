# Project Context

- **Owner:** Casey Irvine (cirvine@microsoft.com)
- **Project:** EditLess — a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)

## Learnings

<!-- Append new learnings below. Each entry is something lasting about the project. -->

- **2026-02-16 — cli-provider.test.ts (#11):** `checkAgencyOnStartup` uses callback-based `exec`, so mocking with synchronous callback invocation works fine for most tests. For the "does not block" assertion, capture the callback without calling it to prove the function returns first. Use `vi.hoisted()` to define mock fns referenced by `vi.mock` factories — vitest hoists `vi.mock` above `const` declarations. The vscode mock in `src/__tests__/mocks/vscode.ts` doesn't have `globalState`; building a bespoke context mock with a `Map`-backed store is simpler and more flexible.
- **2026-02-16 — cli-provider.test.ts (#14):** Generalized update infrastructure tests. To test multi-provider behavior when KNOWN_PROFILES only has one provider with `updateCommand`, mutate the array returned by `getAllProviders()` — it shares references with the internal `_providers`. Each `probeAllProviders()` call creates fresh objects from KNOWN_PROFILES, so mutations don't leak between tests. For testing the `runProviderUpdate` path (user clicks Update), mock `withProgress` to invoke the task callback, mock `showInformationMessage` to resolve with `'Update'`, and `await setTimeout(0)` to flush the `.then()` microtask chain. The 2-arg `exec(cmd, cb)` call in `runProviderUpdate` differs from the 3-arg `exec(cmd, opts, cb)` in `checkSingleProviderUpdate` — use `args[args.length - 1]` to grab the callback in a flexible mock.
- **2026-02-16 — terminal-manager.test.ts (#12):** For `TerminalManager`, mock `vscode.window.terminals` as a mutable array with a getter so `reconcile()` sees live terminals. Capture `onDidCloseTerminal` listener via `mockImplementation` to simulate terminal close events. The `PersistedTerminalInfo` interface is not exported, so redeclare its shape in the test file. Use `Map`-backed `workspaceState` mock (get/update) to track persistence — inspect `update` mock calls to verify what was persisted. The `reconcile()` early-returns on empty saved state, so `workspaceState.update` is never called in that path. `EventEmitter` must be mocked as a class (not plain object) since `TerminalManager` instantiates it with `new`.
- **2026-02-16 — notifications.test.ts (#8):** Use `vi.hoisted()` to define mock fns (`mockGet`, `mockShowWarningMessage`) referenced inside `vi.mock` factories — vitest hoists `vi.mock` above `const` declarations. Mock `vscode.workspace.getConfiguration` to return a single object with a mock `get` that dispatches on key string. For `NotificationManager.checkAndNotify`, the notification only fires when `previousCount === 0 && currentCount > 0` — test the 0→N transition, the N→N no-op, and the suppression paths (master off, category off). Helper factories (`makeConfig`, `makeState`) with `Partial` overrides keep test setup concise and type-safe.
- **2026-02-16 — visibility.test.ts (#19):** `AgentVisibilityManager` reads/writes `string[]` to `workspaceState` under key `editless.hiddenAgents`. A `Map`-backed mock context with `get`/`update`/`keys` is sufficient — no `vi.hoisted()` needed since the vscode mock is a bare object. Test re-instantiation by creating a second manager against the same context to verify state survives construction.
- **2026-02-17 — tree-providers.test.ts & custom-commands.test.ts (#4, #16):** `WorkItemsTreeProvider` and `PRsTreeProvider` now depend on `github-client` — mock `isGhAvailable`, `fetchAssignedIssues`, `fetchMyPRs` alongside vscode. `refresh()` calls async `fetchAll()`, so use `vi.waitFor()` to assert `onDidChangeTreeData` fires. The `_repos.length === 0` guard runs before the `!element` check, so to test the "element returns empty" branch you must first call `setRepos()` and await the fetch. For custom commands, testing the `package.json` schema (required fields, command registration, context menu entries) is more reliable than trying to unit-test the inline handler in `extension.ts`.
- **2026-02-17 — Pre-release coverage audit (#89):** 200 unit tests across 11 files, all passing. 7/19 source modules have good coverage, 5 partial, 7 zero. Biggest gaps: `editless-tree.ts` (core tree view, only getParent tested), `registry.ts` (data persistence layer, zero tests), `session-labels.ts` (label CRUD, zero tests), and all 32 command handlers in `extension.ts` (zero execution tests). Filed 4 P0 issues (#104, #105, #106, #108) and 5 P1 issues (#111, #113, #115, #118, #120). Integration tests in `out/integration/` are picked up by vitest but fail because they need VS Code host — add `out/integration/**` to vitest exclude. Test quality is high overall: descriptive names, appropriate mocks, no skipped tests, good `vi.hoisted()` patterns.
- **2026-02-17 — P0 test coverage (#104, #105, #106, #112):** Added 40 new tests across 3 modules, bringing total from 200 to 240 — all passing. **EditlessTreeProvider** (`tree-providers.test.ts`): 18 new tests covering `getChildren(squad)` returning categories, `getChildren(category)` for roster/decisions/activity, `findTerminalItem` match/miss, `refresh`/`setDiscoveredAgents`/`invalidate` event firing, visibility filtering hiding squads, "all agents hidden" placeholder, discovered agents section, and squad description with session counts. **EditlessRegistry** (`registry.test.ts`): 11 tests covering `loadSquads` (parse, ENOENT, malformed JSON, non-array), `getSquad` (hit, miss, empty), `updateSquad` (persist, missing), `addSquads` (append, create). **SessionLabelManager** (`session-labels.test.ts`): 11 tests covering constructor loading saved state, fresh install safety, `getLabel`/`setLabel`/`clearLabel`/`hasLabel` CRUD with persistence and event verification, no-op clear for missing key. **Vitest config** (`vitest.config.ts`): Added `'out/**'` to exclude array — stops 2 false integration test failures from compiled output. Needed to add `Uri.file` to the vscode mock in `tree-providers.test.ts` for discovered agent tests. PR #122 opened.
