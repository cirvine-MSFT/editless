# Project Context

- **Owner:** Casey Irvine (cirvine@microsoft.com)
- **Project:** EditLess â€” a VS Code extension for managing AI agents, terminal sessions, and work items. The "editorless IDE" panel.
- **Stack:** TypeScript, VS Code Extension API, esbuild, vitest
- **Created:** 2026-02-15
- **Repo:** cirvine-MSFT/editless (private)
- **Prototype:** Ported from tools-squad/extension. Redactor module removed. Rebranded from "Squad Dashboard" to "EditLess."
- **Target:** Internal Microsoft distribution by Monday 2026-02-16 via GitHub Releases (VSIX)
- **User:** Casey is new to GitHub workflows (experienced with ADO). Explain GitHub concepts clearly.

## Learnings


ðŸ“Œ **Team update (2026-02-16):** Documentation animation strategy â€” EditLess uses optimized GIFs stored in docs/media/ directory. Primary tool: ScreenToGif (Windows). Files must be <1 MB, max 800px width, 3â€“8 seconds duration. File naming is descriptive kebab-case (e.g., planning-feature.gif). Re-recording triggers documented: UI structure changes, command/shortcut changes, label changes, layout changes. Team reviews animations on code review checklist. â€” decided by Summer

ðŸ“Œ **Team update (2026-02-16):** Default release target â€” All new issues default to elease:v0.1 unless Casey explicitly directs otherwise. This ensures v0.1 work is automatically tagged correctly. â€” decided by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Use context keys for menu visibility based on dynamic state â€” Gate menu items on VS Code context keys when visibility depends on runtime state that can't be expressed through `viewItem` checks. For the "Upgrade All Squads" button, use `editless.squadUpgradeAvailable` context key set via `vscode.commands.executeCommand('setContext', ...)` in `checkSquadUpgradesOnStartup()`. This pattern applies to all view-level actions depending on aggregate state (e.g., "any squad upgradeable"). â€” decided by Morty

ðŸ“Œ **Team update (2026-02-16):** All bug fixes must include regression tests AND UX tests â€” Bug fixes require both regression test coverage (prevents recurrence) and UX tests (validates user experience). For upgrade scenarios, create tests that either check current state or force an earlier version to validate upgrade paths. Copilot CLI version detection with default settings must be thoroughly tested. â€” decided by Casey Irvine

ðŸ“Œ **Team update (2026-02-16):** Meeseeks writes regression tests for every bug Casey discovers â€” When Casey discovers a bug during usage, Meeseeks should write regression tests for that specific scenario BEFORE Morty fixes it. Tests-first approach for all user-discovered bugs ensures proper coverage and clear verification criteria when the fix lands. â€” decided by Casey Irvine
ðŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine
### 2026-02-16: Go-live audit findings â€” one critical enum mismatch
Pre-release audit (issue #87) found EditLess is production-ready except for one critical blocker: `cli.provider` enum includes `"custom"` but KNOWN_PROFILES in cli-provider.ts does not define a custom profile. When user sets the setting to "custom", resolution fails silently and falls back to auto-detection, confusing UX. Fix: add `{ name: 'custom', command: '', versionCommand: '' }` to KNOWN_PROFILES so custom provider registers with no version/update capabilities (matches decision: custom CLIs get presence-only detection). Secondary findings: settings all follow naming conventions and have sensible defaults, no sensitive terms found (openai/coeus completely removed per decisions), test fixtures use generic names, feature detection is progressive and correct, notification toggles work properly. Documentation gap: README doesn't explain available settings yet (non-blocking, can be post-release patch).

<!-- Append new learnings below. Each entry is something lasting about the project. -->

### 2026-02-16: Full codebase quality review â€” 3 blockers, 5 cleanup items
Pre-release code quality review of entire codebase (19 source files, 12 test suites, 200 tests). Three blockers found: (1) `execSync` in `probeCliVersion()` blocks the extension host activation for up to 15 seconds â€” must be made async. (2) The `custom` provider profile is STILL missing from `KNOWN_PROFILES` â€” was flagged in #87 audit but never patched. (3) `activate()` returns void instead of the test API object required by decisions.md. Five cleanup items: vitest picking up compiled integration test JS files (add `out/**` to exclude), private field access via bracket notation in editless-tree.ts, event listener leaks in EditlessTreeProvider (no Disposable implementation), dead prototype types (DashboardState, WebSocketMessage, LaunchRequest, TerminalSession never imported), and unused `promptRenameSession` export. Security scan clean â€” no openai/coeus references, no hardcoded URLs or tokens, test fixtures use generic names. Architecture is solid: clean dependency graph, no circular deps, strict TypeScript, all commands properly wired in package.json.

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

### 2026-02-15: Vitest mock type signature pattern
Vitest `vi.fn()` does NOT use the `vi.fn<[args], return>` type syntax. Use `.mockResolvedValue()` or `.mockReturnValue()` to set the return type. Example: `vi.fn().mockResolvedValue(undefined as T)` for async mocks. This tripped up the cli-provider tests â€” the `<[string, ...string[]], Promise<string | undefined>>` syntax is invalid and causes TypeScript errors.

### 2026-02-15: PR #14 generalized CLI update infrastructure â€” approved
Reviewed Morty's refactor of agency-specific update logic into provider-generic infrastructure. The abstraction is solid and scales cleanly. Three optional fields on CliProvider (`updateCommand`, `upToDatePattern`, `updateRunCommand`) control per-provider update support. Cache keys are per-provider using `editless.{providerName}UpdatePrompt`. The interface is clean and doesn't force providers to have update capabilities â€” providers without `updateCommand` are silently skipped. Tests cover multi-provider scenarios, cache isolation, and backward compat. `checkAgencyOnStartup` deprecated but still exported â€” that's the right balance for a recent API. All existing tests pass. The loop in `checkProviderUpdatesOnStartup` handles concurrent checks safely (async exec callbacks don't block). **Approved.** This will scale to copilot/claude when we learn their update mechanisms.

### 2026-02-16: PR #12 session persistence â€” approved with observations
Reviewed terminal session persistence implementation. Solves the Developer Window reload bug where terminals survived but disappeared from sidebar. Implementation uses workspaceState for persistence and name-based reconciliation on activation. **Decision: APPROVED.** Code is clean, tests are comprehensive (11 passing tests covering edge cases), and the design tradeoffs are reasonable for this use case. Name-based matching is pragmatic â€” VS Code doesn't provide terminal IDs across reloads, and name collisions are unlikely in practice (terminals are named with timestamp + squad icon). Serialization on every terminal change could theoretically cause perf issues with hundreds of terminals, but that's not a realistic scenario for this extension. The reconcile/persist pattern correctly handles orphaned entries (cleaned on reconcile), counter restoration (prevents index collisions), and onDidCloseTerminal race conditions (separate Map mutations from persistence). TypeScript is strict and clean. One minor edge case: if a user manually renames a terminal, reconciliation will fail silently for that terminal â€” acceptable tradeoff since manual rename is rare and explicitly breaks the contract. This is good engineering: solves the real problem, tests the edges, doesn't over-engineer hypotheticals.

### 2026-02-16: v0.1 release triage â€” P0/P1 locked, 5 items cut to post-release
Final triage session before Monday v0.1 deadline. Analyzed all 25 open issues and produced prioritized action plan. **Key decisions:** (1) **#148 (session labels off-by-one)** â€” new critical bug filed by Casey, assigned to Morty for investigation. Likely edge case in terminal-manager.ts reconciliation logic introduced by PR #12. Labeled as P0/must-fix. (2) **#38 (Squad UI integration)** â€” issue body explicitly says "future work â€” not blocking first release." Removed from v0.1, moved to backlog. (3) **#36, #37, #43 (docs polish)** â€” deferred to post-v0.1. README and workflow docs are complete enough; GIFs/high-level narrative can ship as post-release patch. (4) **#42 (marketplace publishing)** â€” deferred to post-release patch. Marketplace work is an internal process, not part of extension code. (5) **#96, #101 (Agency/CLI provider refactor)** â€” both P1 but need scope review. #101 is architectural (generic provider system) and likely blocks #96 (Agency settings re-eval). May need to defer one or both if Morty+Birdperson are at capacity. **Locked P0/P1 for v0.1:** 7 P0 (builtins, session persistence, work item UX), 8 P1 (documentation, filtering, auto-detection). All have clear acceptance criteria or assigned squad members. Squad can execute to this list with confidence.

### 2026-02-16: Tech debt umbrella issues created â€” #246 (modularity), #247 (test quality)
Created two GitHub umbrella issues to track architectural cleanup and test quality work outside v0.1 release scope. **#246: Reduce coupling and split god objects** â€” Targets extension.ts (943 lines, 23 imports, 11+ managers), editless-tree.ts (453 lines, 9 module coupling), terminal-manager.ts (496 lines, 3 mixed concerns), work-items-tree.ts (443 lines, GitHub+ADO coupling), and scanner.ts (337 lines, facade work). Success criteria: all modules <300 lines, max 8 imports per module, clear single-concern design, circular dep check passes. **#247: Fix LLM-generated test antipatterns** â€” Addresses mock-call assertions without result validation (~25+ instances), tautological tests (16 in work-items-tree), shallow smoke tests (18+), fragile mock coupling (~40 in extension-commands), missing edge case coverage (scanner, status-bar, terminal-manager), and misleading test names (4+). Success criteria: all tests verify mocks AND actual behavior, no tautological tests, edge case coverage, accurate test names, public-API-based construction. Both issues tagged `type:chore` and `release:backlog`. These are non-urgent architectural improvements that can be tackled post-v0.1 as team capacity allows. Modularity work will improve maintainability and reduce future refactor friction; test quality work will increase signal-to-noise and confidence in the suite.

### 2026-02-17: Phase 2 addAgent feature issue created â€” #249
Created GitHub issue #249 to implement Phase 2 of the addAgent work from #125. This issue adds local/repo mode prompting to the `editless.addAgent` command. Dependency on #101 (`createCommand` in cli-provider.ts) is resolved. Assigned to Morty (implementation) and Meeseeks (tests) with labels `type:feature`, `release:backlog`, and `squad:morty`.

### 2026-02-17: Agent-registry promotion feature issue created â€” #250
Created GitHub issue #250 to implement promotion of discovered agents and squads to the agent-registry. This resolves the "bridge gap" between the discovery system (passive display) and the registry (no context menu actions). Issue includes design decision needed: extend `AgentTeamConfig` to support standalone agents (option a) or wrap them in minimal squad containers (option b). Assigned to Rick (design decision), Morty (implementation), and Meeseeks (tests) with labels `type:feature` and `release:backlog`.



ðŸ“Œ **Team update (2026-02-16):** Worktree enforcement reinforced to hard constraint â€” Git checkout violations (agent on #213 checked out branches on the main clone instead of using worktrees) have happened repeatedly despite existing documentation. The rule is now a non-negotiable constraint enforced through code review: the main clone (C:\Users\cirvine\code\work\editless) is PULL-ONLY, all feature branch work must use git worktrees. Violations must be caught and rejected in PR review. â€” reinforced by Casey Irvine
### 2026-02-16: Go-live audit findings â€” one critical enum mismatch
Pre-release audit (issue #87) found EditLess is production-ready except for one critical blocker: `cli.provider` enum includes `"custom"` but KNOWN_PROFILES in cli-provider.ts does not define a custom profile. When user sets the setting to "custom", resolution fails silently and falls back to auto-detection, confusing UX. Fix: add `{ name: 'custom', command: '', versionCommand: '' }` to KNOWN_PROFILES so custom provider registers with no version/update capabilities (matches decision: custom CLIs get presence-only detection). Secondary findings: settings all follow naming conventions and have sensible defaults, no sensitive terms found (openai/coeus completely removed per decisions), test fixtures use generic names, feature detection is progressive and correct, notification toggles work properly. Documentation gap: README doesn't explain available settings yet (non-blocking, can be post-release patch).

<!-- Append new learnings below. Each entry is something lasting about the project. -->

### 2026-02-16: Full codebase quality review â€” 3 blockers, 5 cleanup items
Pre-release code quality review of entire codebase (19 source files, 12 test suites, 200 tests). Three blockers found: (1) `execSync` in `probeCliVersion()` blocks the extension host activation for up to 15 seconds â€” must be made async. (2) The `custom` provider profile is STILL missing from `KNOWN_PROFILES` â€” was flagged in #87 audit but never patched. (3) `activate()` returns void instead of the test API object required by decisions.md. Five cleanup items: vitest picking up compiled integration test JS files (add `out/**` to exclude), private field access via bracket notation in editless-tree.ts, event listener leaks in EditlessTreeProvider (no Disposable implementation), dead prototype types (DashboardState, WebSocketMessage, LaunchRequest, TerminalSession never imported), and unused `promptRenameSession` export. Security scan clean â€” no openai/coeus references, no hardcoded URLs or tokens, test fixtures use generic names. Architecture is solid: clean dependency graph, no circular deps, strict TypeScript, all commands properly wired in package.json.

ðŸ“Œ Team update (2026-02-16): Squad folder rename â€” `.squad/` support added with `.ai-team/` backward compatibility via `src/team-dir.ts` utility. Any future code that needs to locate the team directory must use `resolveTeamDir()` or `resolveTeamMd()` â€” never hardcode paths. â€” decided by Morty

### 2026-02-15: Vitest mock type signature pattern
Vitest `vi.fn()` does NOT use the `vi.fn<[args], return>` type syntax. Use `.mockResolvedValue()` or `.mockReturnValue()` to set the return type. Example: `vi.fn().mockResolvedValue(undefined as T)` for async mocks. This tripped up the cli-provider tests â€” the `<[string, ...string[]], Promise<string | undefined>>` syntax is invalid and causes TypeScript errors.

### 2026-02-15: PR #14 generalized CLI update infrastructure â€” approved
Reviewed Morty's refactor of agency-specific update logic into provider-generic infrastructure. The abstraction is solid and scales cleanly. Three optional fields on CliProvider (`updateCommand`, `upToDatePattern`, `updateRunCommand`) control per-provider update support. Cache keys are per-provider using `editless.{providerName}UpdatePrompt`. The interface is clean and doesn't force providers to have update capabilities â€” providers without `updateCommand` are silently skipped. Tests cover multi-provider scenarios, cache isolation, and backward compat. `checkAgencyOnStartup` deprecated but still exported â€” that's the right balance for a recent API. All existing tests pass. The loop in `checkProviderUpdatesOnStartup` handles concurrent checks safely (async exec callbacks don't block). **Approved.** This will scale to copilot/claude when we learn their update mechanisms.

### 2026-02-16: PR #12 session persistence â€” approved with observations
Reviewed terminal session persistence implementation. Solves the Developer Window reload bug where terminals survived but disappeared from sidebar. Implementation uses workspaceState for persistence and name-based reconciliation on activation. **Decision: APPROVED.** Code is clean, tests are comprehensive (11 passing tests covering edge cases), and the design tradeoffs are reasonable for this use case. Name-based matching is pragmatic â€” VS Code doesn't provide terminal IDs across reloads, and name collisions are unlikely in practice (terminals are named with timestamp + squad icon). Serialization on every terminal change could theoretically cause perf issues with hundreds of terminals, but that's not a realistic scenario for this extension. The reconcile/persist pattern correctly handles orphaned entries (cleaned on reconcile), counter restoration (prevents index collisions), and onDidCloseTerminal race conditions (separate Map mutations from persistence). TypeScript is strict and clean. One minor edge case: if a user manually renames a terminal, reconciliation will fail silently for that terminal â€” acceptable tradeoff since manual rename is rare and explicitly breaks the contract. This is good engineering: solves the real problem, tests the edges, doesn't over-engineer hypotheticals.

### 2026-02-16: v0.1 release triage â€” P0/P1 locked, 5 items cut to post-release
Final triage session before Monday v0.1 deadline. Analyzed all 25 open issues and produced prioritized action plan. **Key decisions:** (1) **#148 (session labels off-by-one)** â€” new critical bug filed by Casey, assigned to Morty for investigation. Likely edge case in terminal-manager.ts reconciliation logic introduced by PR #12. Labeled as P0/must-fix. (2) **#38 (Squad UI integration)** â€” issue body explicitly says "future work â€” not blocking first release." Removed from v0.1, moved to backlog. (3) **#36, #37, #43 (docs polish)** â€” deferred to post-v0.1. README and workflow docs are complete enough; GIFs/high-level narrative can ship as post-release patch. (4) **#42 (marketplace publishing)** â€” deferred to post-release patch. Marketplace work is an internal process, not part of extension code. (5) **#96, #101 (Agency/CLI provider refactor)** â€” both P1 but need scope review. #101 is architectural (generic provider system) and likely blocks #96 (Agency settings re-eval). May need to defer one or both if Morty+Birdperson are at capacity. **Locked P0/P1 for v0.1:** 7 P0 (builtins, session persistence, work item UX), 8 P1 (documentation, filtering, auto-detection). All have clear acceptance criteria or assigned squad members. Squad can execute to this list with confidence.

